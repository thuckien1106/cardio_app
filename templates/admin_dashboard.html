{% extends 'base.html' %} {% block content %}
<div class="container mt-5 pt-4">
  <!-- ========== TIÊU ĐỀ ========== -->
  <div class="text-center mb-5">
    <h2 class="fw-bold text-gradient mb-2">📊 Thống kê hệ thống CVD-App</h2>
    <p class="text-muted">
      Tổng quan hoạt động chẩn đoán, người dùng và hiệu suất bác sĩ.
    </p>
  </div>

  <!-- ========== NÚT XUẤT EXCEL ========== -->
  <div class="text-center mb-5">
    <form method="post" action="{{ url_for('export_admin_stats') }}">
      <button
        type="submit"
        class="btn btn-success btn-lg rounded-pill shadow-sm px-4 py-2"
      >
        📁 Xuất báo cáo Excel
      </button>
    </form>
  </div>

  <!-- ========== KHU 1: THỐNG KÊ CHUNG (3 CARD CÂN ĐỐI) ========== -->
  <div class="row text-center justify-content-center g-4 mb-5">
    <div class="col-md-4 col-sm-6">
      <div class="card border-0 shadow-sm rounded-4 p-3 h-100 bg-light">
        <div class="card-body">
          <h5 class="fw-semibold text-primary mb-2">👨‍⚕️ Bác sĩ</h5>
          <h2 class="fw-bold text-dark">{{ total_doctors }}</h2>
          <p class="text-muted small">Tài khoản bác sĩ</p>
        </div>
      </div>
    </div>

    <div class="col-md-4 col-sm-6">
      <div class="card border-0 shadow-sm rounded-4 p-3 h-100 bg-light">
        <div class="card-body">
          <h5 class="fw-semibold text-success mb-2">🧑‍🤝‍🧑 Bệnh nhân</h5>
          <h2 class="fw-bold text-dark">{{ total_patients }}</h2>
          <p class="text-muted small">Tài khoản bệnh nhân</p>
        </div>
      </div>
    </div>

    <div class="col-md-4 col-sm-6">
      <div class="card border-0 shadow-sm rounded-4 p-3 h-100 bg-light">
        <div class="card-body">
          <h5 class="fw-semibold text-warning mb-2">🩺 Lượt chẩn đoán</h5>
          <h2 class="fw-bold text-dark">{{ total_diagnoses }}</h2>
          <p class="text-muted small">Tổng lượt chẩn đoán trên hệ thống</p>
        </div>
      </div>
    </div>
  </div>

  <!-- ========== KHU 2: BIỂU ĐỒ CHÍNH ========== -->
  <div
    id="chartData"
    data-doctors="{{ total_doctors }}"
    data-patients="{{ total_patients }}"
    data-months="{{ months | join(',') }}"
    data-counts="{{ counts | join(',') }}"
    data-high-risk="{{ high_risk | join(',') }}"
    data-risk-labels="{{ risk_labels | join(',') }}"
    data-risk-values="{{ risk_values | join(',') }}"
    data-top-names="{{ top_names | join(',') }}"
    data-top-counts="{{ top_counts | join(',') }}"
    data-top-rates="{{ top_rates | join(',') }}"
    data-smoke="{{ smoke_percent }}"
    data-alco="{{ alco_percent }}"
    data-active="{{ active_percent }}"
  ></div>

  <div class="row g-4 mb-4">
    <!-- Pie -->
    <div class="col-md-4">
      <div class="card border-0 shadow-sm rounded-4">
        <div class="card-body">
          <h6 class="text-center fw-semibold text-primary mb-3">
            👩‍⚕️ Tỷ lệ Bác sĩ / Bệnh nhân
          </h6>
          <canvas id="pieChart"></canvas>
        </div>
      </div>
    </div>

    <!-- Risk -->
    <div class="col-md-4">
      <div class="card border-0 shadow-sm rounded-4">
        <div class="card-body">
          <h6 class="text-center fw-semibold text-danger mb-3">
            ⚠️ Tỷ lệ Nguy cơ Cao / Thấp
          </h6>
          <canvas id="riskChart"></canvas>
        </div>
      </div>
    </div>

    <!-- Behavior -->
    <div class="col-md-4">
      <div class="card border-0 shadow-sm rounded-4">
        <div class="card-body">
          <h6 class="text-center fw-semibold text-success mb-3">
            💪 Hành vi sức khỏe (Radar)
          </h6>
          <canvas id="behaviorChart"></canvas>
        </div>
      </div>
    </div>
  </div>

  <!-- ========== KHU 3: XU HƯỚNG & TOP DOCTOR ========== -->
  <div class="row g-4 mb-5">
    <div class="col-md-6">
      <div class="card border-0 shadow-sm rounded-4">
        <div class="card-body">
          <h6 class="text-center fw-semibold text-info mb-3">
            📈 Xu hướng chẩn đoán & nguy cơ cao theo tháng
          </h6>
          <canvas id="trendChart" height="220"></canvas>
        </div>
      </div>
    </div>

    <div class="col-md-6">
      <div class="card border-0 shadow-sm rounded-4">
        <div class="card-body">
          <h6 class="text-center fw-semibold text-secondary mb-3">
            🏆 Top 5 bác sĩ có nhiều ca nhất
          </h6>
          <canvas id="topDoctorsChart" height="220"></canvas>
        </div>
      </div>
    </div>
  </div>

  <!-- ========== KHU 4: HIỆU SUẤT BÁC SĨ ========== -->
  <div class="card border-0 shadow-sm rounded-4 mb-5">
    <div class="card-body">
      <h5 class="card-title text-center fw-semibold text-dark mb-4">
        🧠 Hiệu suất chẩn đoán theo bác sĩ
      </h5>
      <canvas id="doctorPerformanceChart" height="260"></canvas>
    </div>
  </div>
</div>

<!-- ========== DỮ LIỆU ========== -->
<div
  id="perfData"
  data-names="{{ perf_names | join(',') }}"
  data-cases="{{ perf_cases | join(',') }}"
  data-rates="{{ perf_rate | join(',') }}"
></div>

<!-- ========== CHART.JS + PLUGINS ========== -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0"></script>

<script>
  const d = document.getElementById("chartData");
  const months = d.dataset.months.split(",");
  const counts = d.dataset.counts.split(",").map(Number);
  const highRisk = d.dataset.highRisk.split(",").map(Number);
  const riskLabels = d.dataset.riskLabels.split(",");
  const riskValues = d.dataset.riskValues.split(",").map(Number);
  const topNames = d.dataset.topNames.split(",");
  const topCounts = d.dataset.topCounts.split(",").map(Number);
  const topRates = d.dataset.topRates.split(",").map(Number);
  const smoke = parseFloat(d.dataset.smoke);
  const alco = parseFloat(d.dataset.alco);
  const active = parseFloat(d.dataset.active);
  const doctors = parseInt(d.dataset.doctors);
  const patients = parseInt(d.dataset.patients);

  const perf = document.getElementById("perfData");
  const perfNames = perf.dataset.names.split(",");
  const perfCases = perf.dataset.cases.split(",").map(Number);
  const perfRates = perf.dataset.rates.split(",").map(Number);

  // ===== 1️⃣ Pie: Bác sĩ / Bệnh nhân =====
  new Chart(document.getElementById("pieChart"), {
    type: "pie",
    data: {
      labels: ["Bác sĩ", "Bệnh nhân"],
      datasets: [
        {
          data: [doctors, patients],
          backgroundColor: ["#36A2EB", "#4CAF50"],
        },
      ],
    },
    options: {
      plugins: {
        legend: { position: "bottom" },
        datalabels: {
          color: "#fff",
          font: { weight: "bold" },
          formatter: (value, ctx) => {
            const total = ctx.chart._metasets[0].total;
            const percentage = ((value / total) * 100).toFixed(1);
            return `${value} (${percentage}%)`;
          },
        },
      },
    },
    plugins: [ChartDataLabels],
  });

  // ===== 2️⃣ Pie: Tỷ lệ Nguy cơ =====
  new Chart(document.getElementById("riskChart"), {
    type: "pie",
    data: {
      labels: riskLabels,
      datasets: [
        {
          data: riskValues,
          backgroundColor: ["#dc3545", "#198754"],
        },
      ],
    },
    options: {
      plugins: {
        legend: { position: "bottom" },
        datalabels: {
          color: "#fff",
          font: { weight: "bold" },
          formatter: (value, ctx) => {
            const total = ctx.chart._metasets[0].total;
            const percentage = ((value / total) * 100).toFixed(1);
            return `${value} (${percentage}%)`;
          },
        },
      },
    },
    plugins: [ChartDataLabels],
  });

  // ===== 3️⃣ Radar: Hành vi sức khỏe =====
  new Chart(document.getElementById("behaviorChart"), {
    type: "radar",
    data: {
      labels: ["Hút thuốc", "Rượu/Bia", "Tập thể dục"],
      datasets: [
        {
          label: "Tỷ lệ (%)",
          data: [smoke, alco, active],
          backgroundColor: "rgba(54,162,235,0.2)",
          borderColor: "#1e63c6",
          pointBackgroundColor: "#1e63c6",
        },
      ],
    },
    options: {
      scales: { r: { suggestedMin: 0, suggestedMax: 100 } },
      plugins: {
        legend: { display: false },
        datalabels: {
          color: "#333",
          formatter: (v) => `${v}%`,
          font: { weight: "bold" },
        },
      },
    },
    plugins: [ChartDataLabels],
  });

  // ===== 4️⃣ Line: Xu hướng =====
  new Chart(document.getElementById("trendChart"), {
    type: "line",
    data: {
      labels: months,
      datasets: [
        {
          label: "Tổng lượt chẩn đoán",
          data: counts,
          borderColor: "#0d6efd",
          backgroundColor: "rgba(13,110,253,0.1)",
          fill: true,
          tension: 0.3,
        },
        {
          label: "Ca nguy cơ cao",
          data: highRisk,
          borderColor: "#dc3545",
          backgroundColor: "rgba(220,53,69,0.1)",
          fill: true,
          tension: 0.3,
        },
      ],
    },
    options: { plugins: { legend: { position: "bottom" } } },
  });

  // ===== 5️⃣ Bar + Line: Top bác sĩ =====
  new Chart(document.getElementById("topDoctorsChart"), {
    type: "bar",
    data: {
      labels: topNames,
      datasets: [
        {
          label: "Số ca chẩn đoán",
          data: topCounts,
          backgroundColor: "#0d6efd",
          borderRadius: 8,
        },
        {
          label: "Tỷ lệ nguy cơ cao (%)",
          data: topRates,
          type: "line",
          borderColor: "#dc3545",
          tension: 0.3,
          yAxisID: "y2",
        },
      ],
    },
    options: {
      responsive: true,
      interaction: { mode: "index", intersect: false },
      stacked: false,
      scales: {
        y: { beginAtZero: true, title: { display: true, text: "Số ca" } },
        y2: {
          type: "linear",
          position: "right",
          beginAtZero: true,
          grid: { drawOnChartArea: false },
        },
      },
      plugins: { legend: { position: "bottom" } },
    },
  });

  // ===== 6️⃣ Hiệu suất bác sĩ =====
  new Chart(document.getElementById("doctorPerformanceChart"), {
    type: "bar",
    data: {
      labels: perfNames,
      datasets: [
        {
          label: "Số ca chẩn đoán",
          data: perfCases,
          backgroundColor: "rgba(13,110,253,0.8)",
          borderRadius: 8,
          yAxisID: "y1",
        },
        {
          label: "Tỷ lệ nguy cơ cao (%)",
          data: perfRates,
          type: "line",
          borderColor: "#dc3545",
          backgroundColor: "rgba(220,53,69,0.2)",
          fill: true,
          tension: 0.3,
          yAxisID: "y2",
        },
      ],
    },
    options: {
      interaction: { mode: "index", intersect: false },
      stacked: false,
      scales: {
        y1: { type: "linear", position: "left", beginAtZero: true },
        y2: {
          type: "linear",
          position: "right",
          beginAtZero: true,
          grid: { drawOnChartArea: false },
        },
      },
      plugins: { legend: { position: "bottom" } },
    },
  });
</script>
{% endblock %}
