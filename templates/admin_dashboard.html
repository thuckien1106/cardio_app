{% extends 'base.html' %} {% block content %}
<div class="container mt-5 pt-4">
  <!-- ====== TIÊU ĐỀ ====== -->
  <div class="text-center mb-5">
    <h2 class="fw-bold text-gradient mb-2">📊 Thống kê Hệ thống</h2>
    <p class="text-muted">
      Tổng quan hoạt động của toàn hệ thống chẩn đoán bệnh tim mạch
    </p>
  </div>

  <!-- ====== NÚT XUẤT EXCEL ====== -->
  <div class="text-center mb-5">
    <form method="post" action="{{ url_for('export_admin_stats') }}">
      <button
        type="submit"
        class="btn btn-success btn-lg rounded-pill shadow-sm px-4 py-2"
      >
        📁 Xuất báo cáo Excel
      </button>
    </form>
  </div>

  <!-- ====== TỔNG QUAN ====== -->
  <div class="row text-center g-4 mb-5">
    <div class="col-md-4">
      <div class="card border-0 shadow-sm rounded-4 p-3 h-100 bg-light">
        <div class="card-body">
          <h5 class="text-primary fw-semibold mb-2">👨‍⚕️ Tổng số bác sĩ</h5>
          <h1 class="fw-bold text-dark">{{ total_doctors }}</h1>
          <p class="text-secondary small">
            Số lượng tài khoản bác sĩ trong hệ thống
          </p>
        </div>
      </div>
    </div>

    <div class="col-md-4">
      <div class="card border-0 shadow-sm rounded-4 p-3 h-100 bg-light">
        <div class="card-body">
          <h5 class="text-success fw-semibold mb-2">🧑‍🤝‍🧑 Tổng số bệnh nhân</h5>
          <h1 class="fw-bold text-dark">{{ total_patients }}</h1>
          <p class="text-secondary small">Số tài khoản bệnh nhân đã đăng ký</p>
        </div>
      </div>
    </div>

    <div class="col-md-4">
      <div class="card border-0 shadow-sm rounded-4 p-3 h-100 bg-light">
        <div class="card-body">
          <h5 class="text-warning fw-semibold mb-2">
            🩺 Tổng số lượt chẩn đoán
          </h5>
          <h1 class="fw-bold text-dark">{{ total_diagnoses }}</h1>
          <p class="text-secondary small">
            Tổng số lần hệ thống đã được sử dụng để chẩn đoán
          </p>
        </div>
      </div>
    </div>
  </div>

  <!-- ====== BIỂU ĐỒ CHÍNH ====== -->
  <div
    id="chartData"
    data-doctors="{{ total_doctors }}"
    data-patients="{{ total_patients }}"
    data-months="{{ months | join(',') }}"
    data-counts="{{ counts | join(',') }}"
    data-risk-labels="{{ risk_labels | join(',') }}"
    data-risk-values="{{ risk_values | join(',') }}"
    data-top-names="{{ top_names | join(',') }}"
    data-top-counts="{{ top_counts | join(',') }}"
  ></div>

  <!-- ====== HÀNG 1: PIE + BAR ====== -->
  <div class="row g-4 mb-4">
    <div class="col-md-6">
      <div class="card border-0 shadow-sm rounded-4">
        <div class="card-body">
          <h5 class="card-title text-center fw-semibold text-primary mb-3">
            Tỷ lệ Bác sĩ / Bệnh nhân
          </h5>
          <canvas id="pieChart" height="200"></canvas>
        </div>
      </div>
    </div>

    <div class="col-md-6">
      <div class="card border-0 shadow-sm rounded-4">
        <div class="card-body">
          <h5 class="card-title text-center fw-semibold text-success mb-3">
            Lượt chẩn đoán theo tháng
          </h5>
          <canvas id="barChart" height="200"></canvas>
        </div>
      </div>
    </div>
  </div>

  <!-- ====== HÀNG 2: RISK + TOP DOCTOR ====== -->
  <div class="row g-4 mb-5">
    <div class="col-md-6">
      <div class="card border-0 shadow-sm rounded-4">
        <div class="card-body">
          <h5 class="card-title text-center fw-semibold text-danger mb-3">
            Tỷ lệ Nguy cơ Cao / Thấp
          </h5>
          <canvas id="riskChart" height="200"></canvas>
        </div>
      </div>
    </div>

    <div class="col-md-6">
      <div class="card border-0 shadow-sm rounded-4">
        <div class="card-body">
          <h5 class="card-title text-center fw-semibold text-info mb-3">
            🏆 Top 5 bác sĩ chẩn đoán nhiều ca nhất
          </h5>
          <canvas id="topDoctorsChart" height="200"></canvas>
        </div>
      </div>
    </div>
  </div>

  <!-- ====== HÀNG 3: HIỆU SUẤT BÁC SĨ ====== -->
  <div class="card border-0 shadow-sm rounded-4 mb-5">
    <div class="card-body">
      <h5 class="card-title text-center fw-semibold text-dark mb-4">
        🧑‍⚕️ Hiệu suất chẩn đoán của bác sĩ
      </h5>
      <canvas id="doctorPerformanceChart" height="260"></canvas>
    </div>
  </div>
</div>

<!-- ====== DỮ LIỆU HIỆU SUẤT BÁC SĨ ====== -->
<div
  id="perfData"
  data-names="{{ perf_names | join(',') }}"
  data-cases="{{ perf_cases | join(',') }}"
  data-rates="{{ perf_rate | join(',') }}"
></div>

<!-- ====== Chart.js ====== -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
  // ==========================
  // Lấy dữ liệu từ data-* HTML
  // ==========================
  const dataDiv = document.getElementById("chartData");
  const numDoctors = parseInt(dataDiv.dataset.doctors);
  const numPatients = parseInt(dataDiv.dataset.patients);
  const months = dataDiv.dataset.months
    ? dataDiv.dataset.months.split(",")
    : [];
  const counts = dataDiv.dataset.counts
    ? dataDiv.dataset.counts.split(",").map(Number)
    : [];
  const riskLabels = dataDiv.dataset.riskLabels
    ? dataDiv.dataset.riskLabels.split(",")
    : [];
  const riskValues = dataDiv.dataset.riskValues
    ? dataDiv.dataset.riskValues.split(",").map(Number)
    : [];
  const topNames = dataDiv.dataset.topNames
    ? dataDiv.dataset.topNames.split(",")
    : [];
  const topCounts = dataDiv.dataset.topCounts
    ? dataDiv.dataset.topCounts.split(",").map(Number)
    : [];

  // Hiệu suất bác sĩ
  const perfDiv = document.getElementById("perfData");
  const perfNames = perfDiv.dataset.names
    ? perfDiv.dataset.names.split(",")
    : [];
  const perfCases = perfDiv.dataset.cases
    ? perfDiv.dataset.cases.split(",").map(Number)
    : [];
  const perfRates = perfDiv.dataset.rates
    ? perfDiv.dataset.rates.split(",").map(Number)
    : [];

  // ==========================
  // 1️⃣ Biểu đồ tròn: Bác sĩ / Bệnh nhân
  // ==========================
  new Chart(document.getElementById("pieChart"), {
    type: "pie",
    data: {
      labels: ["Bác sĩ", "Bệnh nhân"],
      datasets: [
        {
          data: [numDoctors, numPatients],
          backgroundColor: ["#36A2EB", "#4CAF50"],
        },
      ],
    },
    options: { responsive: true, plugins: { legend: { position: "bottom" } } },
  });

  // ==========================
  // 2️⃣ Biểu đồ cột: Lượt chẩn đoán theo tháng
  // ==========================
  new Chart(document.getElementById("barChart"), {
    type: "bar",
    data: {
      labels: months,
      datasets: [
        {
          label: "Số lượt chẩn đoán",
          data: counts,
          backgroundColor: "#FF6384",
          borderRadius: 6,
        },
      ],
    },
    options: {
      responsive: true,
      plugins: { legend: { display: false } },
      scales: {
        y: { beginAtZero: true, title: { display: true, text: "Số lượt" } },
        x: { title: { display: true, text: "Tháng" } },
      },
    },
  });

  // ==========================
  // 3️⃣ Biểu đồ tròn: Tỷ lệ nguy cơ cao / thấp
  // ==========================
  new Chart(document.getElementById("riskChart"), {
    type: "pie",
    data: {
      labels: riskLabels,
      datasets: [{ data: riskValues, backgroundColor: ["#dc3545", "#198754"] }],
    },
    options: { responsive: true, plugins: { legend: { position: "bottom" } } },
  });

  // ==========================
  // 4️⃣ Biểu đồ cột: Top 5 bác sĩ chẩn đoán nhiều ca nhất
  // ==========================
  new Chart(document.getElementById("topDoctorsChart"), {
    type: "bar",
    data: {
      labels: topNames,
      datasets: [
        {
          label: "Số ca chẩn đoán",
          data: topCounts,
          backgroundColor: "#0d6efd",
          borderRadius: 6,
        },
      ],
    },
    options: {
      responsive: true,
      plugins: { legend: { display: false } },
      scales: {
        y: { beginAtZero: true, title: { display: true, text: "Số ca" } },
        x: { title: { display: true, text: "Bác sĩ" } },
      },
    },
  });

  // ==========================
  // 5️⃣ Biểu đồ hiệu suất bác sĩ (Bar + Line)
  // ==========================
  new Chart(document.getElementById("doctorPerformanceChart"), {
    type: "bar",
    data: {
      labels: perfNames,
      datasets: [
        {
          label: "Số ca chẩn đoán",
          data: perfCases,
          backgroundColor: "rgba(13,110,253,0.8)",
          borderRadius: 8,
          yAxisID: "y1",
        },
        {
          label: "Tỷ lệ nguy cơ cao (%)",
          data: perfRates,
          type: "line",
          borderColor: "#dc3545",
          backgroundColor: "rgba(220,53,69,0.2)",
          fill: true,
          tension: 0.3,
          yAxisID: "y2",
        },
      ],
    },
    options: {
      responsive: true,
      interaction: { mode: "index", intersect: false },
      stacked: false,
      scales: {
        y1: {
          type: "linear",
          position: "left",
          beginAtZero: true,
          title: { display: true, text: "Số ca" },
        },
        y2: {
          type: "linear",
          position: "right",
          beginAtZero: true,
          title: { display: true, text: "Tỷ lệ (%)" },
          grid: { drawOnChartArea: false },
        },
      },
      plugins: {
        legend: { position: "bottom" },
        title: {
          display: true,
          text: "Hiệu suất chẩn đoán và tỷ lệ nguy cơ cao theo bác sĩ",
          font: { size: 15 },
        },
      },
    },
  });
</script>
{% endblock %}
