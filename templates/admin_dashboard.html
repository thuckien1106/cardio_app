{% extends 'base.html' %} {% block content %}
<div class="container mt-5 pt-4">
  <!-- ====== TIÃŠU Äá»€ ====== -->
  <div class="text-center mb-5">
    <h2 class="fw-bold text-gradient mb-2">ğŸ“Š Thá»‘ng kÃª Há»‡ thá»‘ng</h2>
    <p class="text-muted">
      Tá»•ng quan hoáº¡t Ä‘á»™ng cá»§a toÃ n há»‡ thá»‘ng cháº©n Ä‘oÃ¡n bá»‡nh tim máº¡ch
    </p>
  </div>

  <!-- ====== NÃšT XUáº¤T EXCEL ====== -->
  <div class="text-center mb-5">
    <form method="post" action="{{ url_for('export_admin_stats') }}">
      <button
        type="submit"
        class="btn btn-success btn-lg rounded-pill shadow-sm px-4 py-2"
      >
        ğŸ“ Xuáº¥t bÃ¡o cÃ¡o Excel
      </button>
    </form>
  </div>

  <!-- ====== Tá»”NG QUAN ====== -->
  <div class="row text-center g-4 mb-5">
    <div class="col-md-4">
      <div class="card border-0 shadow-sm rounded-4 p-3 h-100 bg-light">
        <div class="card-body">
          <h5 class="text-primary fw-semibold mb-2">ğŸ‘¨â€âš•ï¸ Tá»•ng sá»‘ bÃ¡c sÄ©</h5>
          <h1 class="fw-bold text-dark">{{ total_doctors }}</h1>
          <p class="text-secondary small">
            Sá»‘ lÆ°á»£ng tÃ i khoáº£n bÃ¡c sÄ© trong há»‡ thá»‘ng
          </p>
        </div>
      </div>
    </div>

    <div class="col-md-4">
      <div class="card border-0 shadow-sm rounded-4 p-3 h-100 bg-light">
        <div class="card-body">
          <h5 class="text-success fw-semibold mb-2">ğŸ§‘â€ğŸ¤â€ğŸ§‘ Tá»•ng sá»‘ bá»‡nh nhÃ¢n</h5>
          <h1 class="fw-bold text-dark">{{ total_patients }}</h1>
          <p class="text-secondary small">Sá»‘ tÃ i khoáº£n bá»‡nh nhÃ¢n Ä‘Ã£ Ä‘Äƒng kÃ½</p>
        </div>
      </div>
    </div>

    <div class="col-md-4">
      <div class="card border-0 shadow-sm rounded-4 p-3 h-100 bg-light">
        <div class="card-body">
          <h5 class="text-warning fw-semibold mb-2">
            ğŸ©º Tá»•ng sá»‘ lÆ°á»£t cháº©n Ä‘oÃ¡n
          </h5>
          <h1 class="fw-bold text-dark">{{ total_diagnoses }}</h1>
          <p class="text-secondary small">
            Tá»•ng sá»‘ láº§n há»‡ thá»‘ng Ä‘Ã£ Ä‘Æ°á»£c sá»­ dá»¥ng Ä‘á»ƒ cháº©n Ä‘oÃ¡n
          </p>
        </div>
      </div>
    </div>
  </div>

  <!-- ====== BIá»‚U Äá»’ CHÃNH ====== -->
  <div
    id="chartData"
    data-doctors="{{ total_doctors }}"
    data-patients="{{ total_patients }}"
    data-months="{{ months | join(',') }}"
    data-counts="{{ counts | join(',') }}"
    data-risk-labels="{{ risk_labels | join(',') }}"
    data-risk-values="{{ risk_values | join(',') }}"
    data-top-names="{{ top_names | join(',') }}"
    data-top-counts="{{ top_counts | join(',') }}"
  ></div>

  <!-- ====== HÃ€NG 1: PIE + BAR ====== -->
  <div class="row g-4 mb-4">
    <div class="col-md-6">
      <div class="card border-0 shadow-sm rounded-4">
        <div class="card-body">
          <h5 class="card-title text-center fw-semibold text-primary mb-3">
            Tá»· lá»‡ BÃ¡c sÄ© / Bá»‡nh nhÃ¢n
          </h5>
          <canvas id="pieChart" height="200"></canvas>
        </div>
      </div>
    </div>

    <div class="col-md-6">
      <div class="card border-0 shadow-sm rounded-4">
        <div class="card-body">
          <h5 class="card-title text-center fw-semibold text-success mb-3">
            LÆ°á»£t cháº©n Ä‘oÃ¡n theo thÃ¡ng
          </h5>
          <canvas id="barChart" height="200"></canvas>
        </div>
      </div>
    </div>
  </div>

  <!-- ====== HÃ€NG 2: RISK + TOP DOCTOR ====== -->
  <div class="row g-4 mb-5">
    <div class="col-md-6">
      <div class="card border-0 shadow-sm rounded-4">
        <div class="card-body">
          <h5 class="card-title text-center fw-semibold text-danger mb-3">
            Tá»· lá»‡ Nguy cÆ¡ Cao / Tháº¥p
          </h5>
          <canvas id="riskChart" height="200"></canvas>
        </div>
      </div>
    </div>

    <div class="col-md-6">
      <div class="card border-0 shadow-sm rounded-4">
        <div class="card-body">
          <h5 class="card-title text-center fw-semibold text-info mb-3">
            ğŸ† Top 5 bÃ¡c sÄ© cháº©n Ä‘oÃ¡n nhiá»u ca nháº¥t
          </h5>
          <canvas id="topDoctorsChart" height="200"></canvas>
        </div>
      </div>
    </div>
  </div>

  <!-- ====== HÃ€NG 3: HIá»†U SUáº¤T BÃC SÄ¨ ====== -->
  <div class="card border-0 shadow-sm rounded-4 mb-5">
    <div class="card-body">
      <h5 class="card-title text-center fw-semibold text-dark mb-4">
        ğŸ§‘â€âš•ï¸ Hiá»‡u suáº¥t cháº©n Ä‘oÃ¡n cá»§a bÃ¡c sÄ©
      </h5>
      <canvas id="doctorPerformanceChart" height="260"></canvas>
    </div>
  </div>
</div>

<!-- ====== Dá»® LIá»†U HIá»†U SUáº¤T BÃC SÄ¨ ====== -->
<div
  id="perfData"
  data-names="{{ perf_names | join(',') }}"
  data-cases="{{ perf_cases | join(',') }}"
  data-rates="{{ perf_rate | join(',') }}"
></div>

<!-- ====== Chart.js ====== -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
  // ==========================
  // Láº¥y dá»¯ liá»‡u tá»« data-* HTML
  // ==========================
  const dataDiv = document.getElementById("chartData");
  const numDoctors = parseInt(dataDiv.dataset.doctors);
  const numPatients = parseInt(dataDiv.dataset.patients);
  const months = dataDiv.dataset.months
    ? dataDiv.dataset.months.split(",")
    : [];
  const counts = dataDiv.dataset.counts
    ? dataDiv.dataset.counts.split(",").map(Number)
    : [];
  const riskLabels = dataDiv.dataset.riskLabels
    ? dataDiv.dataset.riskLabels.split(",")
    : [];
  const riskValues = dataDiv.dataset.riskValues
    ? dataDiv.dataset.riskValues.split(",").map(Number)
    : [];
  const topNames = dataDiv.dataset.topNames
    ? dataDiv.dataset.topNames.split(",")
    : [];
  const topCounts = dataDiv.dataset.topCounts
    ? dataDiv.dataset.topCounts.split(",").map(Number)
    : [];

  // Hiá»‡u suáº¥t bÃ¡c sÄ©
  const perfDiv = document.getElementById("perfData");
  const perfNames = perfDiv.dataset.names
    ? perfDiv.dataset.names.split(",")
    : [];
  const perfCases = perfDiv.dataset.cases
    ? perfDiv.dataset.cases.split(",").map(Number)
    : [];
  const perfRates = perfDiv.dataset.rates
    ? perfDiv.dataset.rates.split(",").map(Number)
    : [];

  // ==========================
  // 1ï¸âƒ£ Biá»ƒu Ä‘á»“ trÃ²n: BÃ¡c sÄ© / Bá»‡nh nhÃ¢n
  // ==========================
  new Chart(document.getElementById("pieChart"), {
    type: "pie",
    data: {
      labels: ["BÃ¡c sÄ©", "Bá»‡nh nhÃ¢n"],
      datasets: [
        {
          data: [numDoctors, numPatients],
          backgroundColor: ["#36A2EB", "#4CAF50"],
        },
      ],
    },
    options: { responsive: true, plugins: { legend: { position: "bottom" } } },
  });

  // ==========================
  // 2ï¸âƒ£ Biá»ƒu Ä‘á»“ cá»™t: LÆ°á»£t cháº©n Ä‘oÃ¡n theo thÃ¡ng
  // ==========================
  new Chart(document.getElementById("barChart"), {
    type: "bar",
    data: {
      labels: months,
      datasets: [
        {
          label: "Sá»‘ lÆ°á»£t cháº©n Ä‘oÃ¡n",
          data: counts,
          backgroundColor: "#FF6384",
          borderRadius: 6,
        },
      ],
    },
    options: {
      responsive: true,
      plugins: { legend: { display: false } },
      scales: {
        y: { beginAtZero: true, title: { display: true, text: "Sá»‘ lÆ°á»£t" } },
        x: { title: { display: true, text: "ThÃ¡ng" } },
      },
    },
  });

  // ==========================
  // 3ï¸âƒ£ Biá»ƒu Ä‘á»“ trÃ²n: Tá»· lá»‡ nguy cÆ¡ cao / tháº¥p
  // ==========================
  new Chart(document.getElementById("riskChart"), {
    type: "pie",
    data: {
      labels: riskLabels,
      datasets: [{ data: riskValues, backgroundColor: ["#dc3545", "#198754"] }],
    },
    options: { responsive: true, plugins: { legend: { position: "bottom" } } },
  });

  // ==========================
  // 4ï¸âƒ£ Biá»ƒu Ä‘á»“ cá»™t: Top 5 bÃ¡c sÄ© cháº©n Ä‘oÃ¡n nhiá»u ca nháº¥t
  // ==========================
  new Chart(document.getElementById("topDoctorsChart"), {
    type: "bar",
    data: {
      labels: topNames,
      datasets: [
        {
          label: "Sá»‘ ca cháº©n Ä‘oÃ¡n",
          data: topCounts,
          backgroundColor: "#0d6efd",
          borderRadius: 6,
        },
      ],
    },
    options: {
      responsive: true,
      plugins: { legend: { display: false } },
      scales: {
        y: { beginAtZero: true, title: { display: true, text: "Sá»‘ ca" } },
        x: { title: { display: true, text: "BÃ¡c sÄ©" } },
      },
    },
  });

  // ==========================
  // 5ï¸âƒ£ Biá»ƒu Ä‘á»“ hiá»‡u suáº¥t bÃ¡c sÄ© (Bar + Line)
  // ==========================
  new Chart(document.getElementById("doctorPerformanceChart"), {
    type: "bar",
    data: {
      labels: perfNames,
      datasets: [
        {
          label: "Sá»‘ ca cháº©n Ä‘oÃ¡n",
          data: perfCases,
          backgroundColor: "rgba(13,110,253,0.8)",
          borderRadius: 8,
          yAxisID: "y1",
        },
        {
          label: "Tá»· lá»‡ nguy cÆ¡ cao (%)",
          data: perfRates,
          type: "line",
          borderColor: "#dc3545",
          backgroundColor: "rgba(220,53,69,0.2)",
          fill: true,
          tension: 0.3,
          yAxisID: "y2",
        },
      ],
    },
    options: {
      responsive: true,
      interaction: { mode: "index", intersect: false },
      stacked: false,
      scales: {
        y1: {
          type: "linear",
          position: "left",
          beginAtZero: true,
          title: { display: true, text: "Sá»‘ ca" },
        },
        y2: {
          type: "linear",
          position: "right",
          beginAtZero: true,
          title: { display: true, text: "Tá»· lá»‡ (%)" },
          grid: { drawOnChartArea: false },
        },
      },
      plugins: {
        legend: { position: "bottom" },
        title: {
          display: true,
          text: "Hiá»‡u suáº¥t cháº©n Ä‘oÃ¡n vÃ  tá»· lá»‡ nguy cÆ¡ cao theo bÃ¡c sÄ©",
          font: { size: 15 },
        },
      },
    },
  });
</script>
{% endblock %}
