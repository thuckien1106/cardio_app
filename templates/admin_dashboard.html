{% extends 'base.html' %} {% block content %}
<div class="container mt-3 pt-3">
  <!-- ========== TI√äU ƒê·ªÄ ========== -->
  <div class="text-center mb-5">
    <h2 class="fw-bold text-gradient mb-2">üìä Th·ªëng k√™ h·ªá th·ªëng CVD-App</h2>
    <p class="text-muted">
      T·ªïng quan ho·∫°t ƒë·ªông ch·∫©n ƒëo√°n, ng∆∞·ªùi d√πng v√† hi·ªáu su·∫•t b√°c sƒ©.
    </p>
  </div>

  <!-- ========== N√öT XU·∫§T EXCEL ========== -->
  <div class="text-center mb-5">
    <form method="post" action="{{ url_for('export_admin_stats') }}">
      <button
        type="submit"
        class="btn btn-success btn-lg rounded-pill shadow-sm px-4 py-2"
      >
        üìÅ Xu·∫•t b√°o c√°o Excel
      </button>
    </form>
  </div>

  <!-- ========== KHU 1: TH·ªêNG K√ä CHUNG (3 CARD C√ÇN ƒê·ªêI) ========== -->
  <div class="row text-center justify-content-center g-4 mb-5">
    <div class="col-md-4 col-sm-6">
      <div class="card border-0 shadow-sm rounded-4 p-3 h-100 bg-light">
        <div class="card-body">
          <h5 class="fw-semibold text-primary mb-2">üë®‚Äç‚öïÔ∏è B√°c sƒ©</h5>
          <h2 class="fw-bold text-dark">{{ total_doctors }}</h2>
          <p class="text-muted small">T√†i kho·∫£n b√°c sƒ©</p>
        </div>
      </div>
    </div>

    <div class="col-md-4 col-sm-6">
      <div class="card border-0 shadow-sm rounded-4 p-3 h-100 bg-light">
        <div class="card-body">
          <h5 class="fw-semibold text-success mb-2">üßë‚Äçü§ù‚Äçüßë B·ªánh nh√¢n</h5>
          <h2 class="fw-bold text-dark">{{ total_patients }}</h2>
          <p class="text-muted small">T√†i kho·∫£n b·ªánh nh√¢n</p>
        </div>
      </div>
    </div>

    <div class="col-md-4 col-sm-6">
      <div class="card border-0 shadow-sm rounded-4 p-3 h-100 bg-light">
        <div class="card-body">
          <h5 class="fw-semibold text-warning mb-2">ü©∫ L∆∞·ª£t ch·∫©n ƒëo√°n</h5>
          <h2 class="fw-bold text-dark">{{ total_diagnoses }}</h2>
          <p class="text-muted small">T·ªïng l∆∞·ª£t ch·∫©n ƒëo√°n tr√™n h·ªá th·ªëng</p>
        </div>
      </div>
    </div>
  </div>

  <!-- ========== KHU 2: BI·ªÇU ƒê·ªí CH√çNH ========== -->
  <div
    id="chartData"
    data-doctors="{{ total_doctors }}"
    data-patients="{{ total_patients }}"
    data-months="{{ months | join(',') }}"
    data-counts="{{ counts | join(',') }}"
    data-high-risk="{{ high_risk | join(',') }}"
    data-risk-labels="{{ risk_labels | join(',') }}"
    data-risk-values="{{ risk_values | join(',') }}"
    data-top-names="{{ top_names | join(',') }}"
    data-top-counts="{{ top_counts | join(',') }}"
    data-top-rates="{{ top_rates | join(',') }}"
    data-smoke="{{ smoke_percent }}"
    data-alco="{{ alco_percent }}"
    data-active="{{ active_percent }}"
  ></div>

  <div class="row g-4 mb-4">
    <!-- Pie -->
    <div class="col-md-4">
      <div class="card border-0 shadow-sm rounded-4">
        <div class="card-body">
          <h6 class="text-center fw-semibold text-primary mb-3">
            üë©‚Äç‚öïÔ∏è T·ª∑ l·ªá B√°c sƒ© / B·ªánh nh√¢n
          </h6>
          <canvas id="pieChart"></canvas>
        </div>
      </div>
    </div>

    <!-- Risk -->
    <div class="col-md-4">
      <div class="card border-0 shadow-sm rounded-4">
        <div class="card-body">
          <h6 class="text-center fw-semibold text-danger mb-3">
            ‚ö†Ô∏è T·ª∑ l·ªá Nguy c∆° Cao / Th·∫•p
          </h6>
          <canvas id="riskChart"></canvas>
        </div>
      </div>
    </div>

    <!-- Behavior -->
    <div class="col-md-4">
      <div class="card border-0 shadow-sm rounded-4">
        <div class="card-body">
          <h6 class="text-center fw-semibold text-success mb-3">
            üí™ H√†nh vi s·ª©c kh·ªèe (Radar)
          </h6>
          <canvas id="behaviorChart"></canvas>
        </div>
      </div>
    </div>
  </div>

  <!-- ========== KHU 3: XU H∆Ø·ªöNG & TOP DOCTOR ========== -->
  <div class="row g-4 mb-5">
    <div class="col-md-6">
      <div class="card border-0 shadow-sm rounded-4">
        <div class="card-body">
          <h6 class="text-center fw-semibold text-info mb-3">
            üìà Xu h∆∞·ªõng ch·∫©n ƒëo√°n & nguy c∆° cao theo th√°ng
          </h6>
          <canvas id="trendChart" height="220"></canvas>
        </div>
      </div>
    </div>

    <div class="col-md-6">
      <div class="card border-0 shadow-sm rounded-4">
        <div class="card-body">
          <h6 class="text-center fw-semibold text-secondary mb-3">
            üèÜ Top 5 b√°c sƒ© c√≥ nhi·ªÅu ca nh·∫•t
          </h6>
          <canvas id="topDoctorsChart" height="220"></canvas>
        </div>
      </div>
    </div>
  </div>

  <!-- ========== KHU 4: HI·ªÜU SU·∫§T B√ÅC Sƒ® ========== -->
  <div class="card border-0 shadow-sm rounded-4 mb-5">
    <div class="card-body">
      <h5 class="card-title text-center fw-semibold text-dark mb-4">
        üß† Hi·ªáu su·∫•t ch·∫©n ƒëo√°n theo b√°c sƒ©
      </h5>
      <canvas id="doctorPerformanceChart" height="260"></canvas>
    </div>
  </div>
</div>

<!-- ========== D·ªÆ LI·ªÜU ========== -->
<div
  id="perfData"
  data-names="{{ perf_names | join(',') }}"
  data-cases="{{ perf_cases | join(',') }}"
  data-rates="{{ perf_rate | join(',') }}"
></div>

<!-- ========== CHART.JS + PLUGINS ========== -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0"></script>

<script>
  const d = document.getElementById("chartData");
  const months = d.dataset.months.split(",");
  const counts = d.dataset.counts.split(",").map(Number);
  const highRisk = d.dataset.highRisk.split(",").map(Number);
  const riskLabels = d.dataset.riskLabels.split(",");
  const riskValues = d.dataset.riskValues.split(",").map(Number);
  const topNames = d.dataset.topNames.split(",");
  const topCounts = d.dataset.topCounts.split(",").map(Number);
  const topRates = d.dataset.topRates.split(",").map(Number);
  const smoke = parseFloat(d.dataset.smoke);
  const alco = parseFloat(d.dataset.alco);
  const active = parseFloat(d.dataset.active);
  const doctors = parseInt(d.dataset.doctors);
  const patients = parseInt(d.dataset.patients);

  const perf = document.getElementById("perfData");
  const perfNames = perf.dataset.names.split(",");
  const perfCases = perf.dataset.cases.split(",").map(Number);
  const perfRates = perf.dataset.rates.split(",").map(Number);

  // ===== 1Ô∏è‚É£ Pie: B√°c sƒ© / B·ªánh nh√¢n =====
  new Chart(document.getElementById("pieChart"), {
    type: "pie",
    data: {
      labels: ["B√°c sƒ©", "B·ªánh nh√¢n"],
      datasets: [
        {
          data: [doctors, patients],
          backgroundColor: ["#36A2EB", "#4CAF50"],
        },
      ],
    },
    options: {
      plugins: {
        legend: { position: "bottom" },
        datalabels: {
          color: "#fff",
          font: { weight: "bold" },
          formatter: (value, ctx) => {
            const total = ctx.chart._metasets[0].total;
            const percentage = ((value / total) * 100).toFixed(1);
            return `${value} (${percentage}%)`;
          },
        },
      },
    },
    plugins: [ChartDataLabels],
  });

  // ===== 2Ô∏è‚É£ Pie: T·ª∑ l·ªá Nguy c∆° =====
  new Chart(document.getElementById("riskChart"), {
    type: "pie",
    data: {
      labels: riskLabels,
      datasets: [
        {
          data: riskValues,
          backgroundColor: ["#dc3545", "#198754"],
        },
      ],
    },
    options: {
      plugins: {
        legend: { position: "bottom" },
        datalabels: {
          color: "#fff",
          font: { weight: "bold" },
          formatter: (value, ctx) => {
            const total = ctx.chart._metasets[0].total;
            const percentage = ((value / total) * 100).toFixed(1);
            return `${value} (${percentage}%)`;
          },
        },
      },
    },
    plugins: [ChartDataLabels],
  });

  // ===== 3Ô∏è‚É£ Radar: H√†nh vi s·ª©c kh·ªèe =====
  new Chart(document.getElementById("behaviorChart"), {
    type: "radar",
    data: {
      labels: ["H√∫t thu·ªëc", "R∆∞·ª£u/Bia", "T·∫≠p th·ªÉ d·ª•c"],
      datasets: [
        {
          label: "T·ª∑ l·ªá (%)",
          data: [smoke, alco, active],
          backgroundColor: "rgba(54,162,235,0.2)",
          borderColor: "#1e63c6",
          pointBackgroundColor: "#1e63c6",
        },
      ],
    },
    options: {
      scales: { r: { suggestedMin: 0, suggestedMax: 100 } },
      plugins: {
        legend: { display: false },
        datalabels: {
          color: "#333",
          formatter: (v) => `${v}%`,
          font: { weight: "bold" },
        },
      },
    },
    plugins: [ChartDataLabels],
  });

  // ===== 4Ô∏è‚É£ Line: Xu h∆∞·ªõng =====
  new Chart(document.getElementById("trendChart"), {
    type: "line",
    data: {
      labels: months,
      datasets: [
        {
          label: "T·ªïng l∆∞·ª£t ch·∫©n ƒëo√°n",
          data: counts,
          borderColor: "#0d6efd",
          backgroundColor: "rgba(13,110,253,0.1)",
          fill: true,
          tension: 0.3,
        },
        {
          label: "Ca nguy c∆° cao",
          data: highRisk,
          borderColor: "#dc3545",
          backgroundColor: "rgba(220,53,69,0.1)",
          fill: true,
          tension: 0.3,
        },
      ],
    },
    options: { plugins: { legend: { position: "bottom" } } },
  });

  // ===== 5Ô∏è‚É£ Bar + Line: Top b√°c sƒ© =====
  new Chart(document.getElementById("topDoctorsChart"), {
    type: "bar",
    data: {
      labels: topNames,
      datasets: [
        {
          label: "S·ªë ca ch·∫©n ƒëo√°n",
          data: topCounts,
          backgroundColor: "#0d6efd",
          borderRadius: 8,
        },
        {
          label: "T·ª∑ l·ªá nguy c∆° cao (%)",
          data: topRates,
          type: "line",
          borderColor: "#dc3545",
          tension: 0.3,
          yAxisID: "y2",
        },
      ],
    },
    options: {
      responsive: true,
      interaction: { mode: "index", intersect: false },
      stacked: false,
      scales: {
        y: { beginAtZero: true, title: { display: true, text: "S·ªë ca" } },
        y2: {
          type: "linear",
          position: "right",
          beginAtZero: true,
          grid: { drawOnChartArea: false },
        },
      },
      plugins: { legend: { position: "bottom" } },
    },
  });

  // ===== 6Ô∏è‚É£ Hi·ªáu su·∫•t b√°c sƒ© =====
  new Chart(document.getElementById("doctorPerformanceChart"), {
    type: "bar",
    data: {
      labels: perfNames,
      datasets: [
        {
          label: "S·ªë ca ch·∫©n ƒëo√°n",
          data: perfCases,
          backgroundColor: "rgba(13,110,253,0.8)",
          borderRadius: 8,
          yAxisID: "y1",
        },
        {
          label: "T·ª∑ l·ªá nguy c∆° cao (%)",
          data: perfRates,
          type: "line",
          borderColor: "#dc3545",
          backgroundColor: "rgba(220,53,69,0.2)",
          fill: true,
          tension: 0.3,
          yAxisID: "y2",
        },
      ],
    },
    options: {
      interaction: { mode: "index", intersect: false },
      stacked: false,
      scales: {
        y1: { type: "linear", position: "left", beginAtZero: true },
        y2: {
          type: "linear",
          position: "right",
          beginAtZero: true,
          grid: { drawOnChartArea: false },
        },
      },
      plugins: { legend: { position: "bottom" } },
    },
  });
</script>
{% endblock %}
