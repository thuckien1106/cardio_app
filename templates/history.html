{% extends 'base.html' %}
{% block content %}
<div class="container mt-5 pt-4">

  <!-- Ti√™u ƒë·ªÅ -->
  <div class="text-center mb-4">
    <h2 class="fw-bold text-gradient">üìú L·ªãch s·ª≠ ch·∫©n ƒëo√°n</h2>
    <p class="text-muted mb-0">
      {% if session['role'] == 'doctor' %}
      Danh s√°ch k·∫øt qu·∫£ ch·∫©n ƒëo√°n c·ªßa b·ªánh nh√¢n do b·∫°n ph·ª• tr√°ch. Nh·∫•n <b>‚ÄúXem chi ti·∫øt‚Äù</b> ƒë·ªÉ m·ªü ho·∫∑c ƒë√≥ng th√¥ng tin ƒë·∫ßy ƒë·ªß.
      {% elif session['role'] == 'admin' %}
      Qu·∫£n tr·ªã vi√™n c√≥ th·ªÉ xem to√†n b·ªô l·ªãch s·ª≠ ch·∫©n ƒëo√°n trong h·ªá th·ªëng.
      {% else %}
      L·ªãch s·ª≠ ch·∫©n ƒëo√°n c·ªßa b·∫°n, bao g·ªìm c√°c l·∫ßn t·ª± ch·∫©n ƒëo√°n v√† ƒë∆∞·ª£c b√°c sƒ© ch·∫©n ƒëo√°n.
      {% endif %}
    </p>
  </div>

  <!-- B·ªô l·ªçc -->
<form method="get" class="card p-3 shadow-sm border-0 mb-4 rounded-4">
  <div class="row g-3 align-items-end">

    <div class="col-md-3">
      <label class="form-label fw-semibold">T·ª´ ng√†y</label>
      <input type="date" name="start_date" class="form-control shadow-sm" value="{{ start_date }}">
    </div>

    <div class="col-md-3">
      <label class="form-label fw-semibold">ƒê·∫øn ng√†y</label>
      <input type="date" name="end_date" class="form-control shadow-sm" value="{{ end_date }}">
    </div>

    {% if session['role'] == 'doctor' %}
    <div class="col-md-3">
      <label class="form-label fw-semibold">B·ªánh nh√¢n</label>
      <select name="patient_id" class="form-select shadow-sm">
        <option value="">T·∫•t c·∫£</option>
        {% for p in patients %}
        <option value="{{ p.ID }}" {% if patient_id==p.ID|string %}selected{% endif %}>{{ p.HoTen }}</option>
        {% endfor %}
      </select>
    </div>
    {% elif session['role'] == 'admin' %}
    <div class="col-md-3">
      <label class="form-label fw-semibold">B√°c sƒ©</label>
      <select name="doctor_id" class="form-select shadow-sm">
        <option value="">T·∫•t c·∫£</option>
        {% for d in doctors %}
        <option value="{{ d.ID }}" {% if doctor_id==d.ID|string %}selected{% endif %}>{{ d.HoTen }}</option>
        {% endfor %}
      </select>
    </div>
    <div class="col-md-3">
      <label class="form-label fw-semibold">B·ªánh nh√¢n</label>
      <select name="patient_id" class="form-select shadow-sm">
        <option value="">T·∫•t c·∫£</option>
        {% for p in patients %}
        <option value="{{ p.ID }}" {% if patient_id==p.ID|string %}selected{% endif %}>{{ p.HoTen }}</option>
        {% endfor %}
      </select>
    </div>
    {% endif %}

    <div class="col-md-2">
      <label class="form-label fw-semibold">Nguy c∆°</label>
      <select name="risk_filter" class="form-select shadow-sm">
        <option value="">T·∫•t c·∫£</option>
        <option value="high" {% if risk_filter=='high' %}selected{% endif %}>Cao</option>
        <option value="low" {% if risk_filter=='low' %}selected{% endif %}>Th·∫•p</option>
      </select>
    </div>

    <div class="col-md-2">
      <label class="form-label fw-semibold">S·∫Øp x·∫øp</label>
      <select name="sort" class="form-select shadow-sm">
        <option value="desc" {% if sort_order=='desc' %}selected{% endif %}>M·ªõi nh·∫•t</option>
        <option value="asc" {% if sort_order=='asc' %}selected{% endif %}>C≈© nh·∫•t</option>
      </select>
    </div>

    <div class="col-md-12 d-flex justify-content-end mt-3">
      <div class="d-flex gap-2">
        <button type="submit" class="btn btn-primary rounded-pill px-4 shadow-sm">
          üîç L·ªçc d·ªØ li·ªáu
        </button>
        <a href="{{ url_for('history') }}" class="btn btn-outline-secondary rounded-pill px-4 shadow-sm">
          üîÑ L√†m m·ªõi
        </a>
      </div>
    </div>
  </div>
</form>


  <!-- T·ªïng s·ªë k·∫øt qu·∫£ -->
  {% if records and records|length > 0 %}
  <div class="alert alert-secondary d-flex justify-content-between align-items-center shadow-sm rounded-pill py-2 px-4 mb-3">
    <span><i class="bi bi-bar-chart-line me-2"></i><b>T·ªïng s·ªë k·∫øt qu·∫£:</b> {{ total_records }}</span>
    {% if start_date or end_date or risk_filter or doctor_id %}
    <span class="text-muted small fst-italic">ƒêang hi·ªÉn th·ªã d·ªØ li·ªáu ƒë√£ l·ªçc</span>
    {% else %}
    <span class="text-muted small fst-italic">To√†n b·ªô l·ªãch s·ª≠</span>
    {% endif %}
  </div>

  <!-- B·∫£ng -->
<div class="table-responsive shadow-sm rounded-4">
  <table class="table table-hover align-middle mb-0">
    <thead class="table-primary text-center">
      <tr>
        {% if session['role'] == 'doctor' %}
          <th>M√£ BN</th>
          <th>B·ªánh nh√¢n</th>
          <th>Tu·ªïi</th>
          <th>Gi·ªõi t√≠nh</th>
          <th>Nguy c∆°</th>
          <th>Ng√†y ch·∫©n ƒëo√°n</th>
          <th></th>
        {% elif session['role'] == 'admin' %}
          <th>M√£ BN</th>
          <th>B·ªánh nh√¢n</th>
          <th>Tu·ªïi</th>
          <th>Gi·ªõi t√≠nh</th>
          <th>Nguy c∆°</th>
          <th>B√°c sƒ©</th>
          <th>Ng√†y ch·∫©n ƒëo√°n</th>
          <th></th>
        {% else %}
          <th>Tu·ªïi</th>
          <th>Gi·ªõi t√≠nh</th>
          <th>Nguy c∆°</th>
          <th>B√°c sƒ©</th>
          <th>Ng√†y ch·∫©n ƒëo√°n</th>
          <th></th>
        {% endif %}
      </tr>
    </thead>

    <tbody>
      {% for r in records %}
      <tr class="align-middle">
        {% if session['role'] == 'doctor' or session['role'] == 'admin' %}
          <td class="text-center fw-semibold">
            {{ 'BN' + '%03d'|format(r.BenhNhanID) }}
          </td>
          <td class="fw-semibold">{{ r.TenBenhNhan }}</td>
        {% endif %}

        <td class="text-center">{{ r.Tuoi or '-' }}</td>
        <td class="text-center">{{ r.GioiTinh or '-' }}</td>
        <td class="text-center">
          {% if 'cao' in r.NguyCo|lower %}
            <span class="badge bg-danger px-3 py-2">{{ r.NguyCo }}</span>
          {% else %}
            <span class="badge bg-success px-3 py-2">{{ r.NguyCo }}</span>
          {% endif %}
        </td>

        {% if session['role'] == 'admin' or session['role'] == 'patient' %}
          <td class="text-center">
            {% if r.TenBacSi %}
              {{ r.TenBacSi }}
            {% else %}
              <span class="text-muted fst-italic">B·ªánh nh√¢n t·ª± ch·∫©n ƒëo√°n</span>
            {% endif %}
          </td>
        {% endif %}

        <td class="text-center">
          {{ r.NgayChanDoan.strftime('%d/%m/%Y') if r.NgayChanDoan else '‚Äî' }}
        </td>

        <td class="text-center">
          <button type="button" class="btn btn-sm btn-outline-primary rounded-pill px-3 toggle-detail"
            data-target="#detail{{ r.ChanDoanID }}">
            üîç Xem chi ti·∫øt
          </button>
        </td>
      </tr>

      <!-- H√†ng chi ti·∫øt -->
      <tr id="detail{{ r.ChanDoanID }}" class="collapse bg-light detail-row">
        <td colspan="8" class="p-3">
          <div class="row g-3 small">
            <div class="col-md-3"><b>BMI:</b> {{ r.BMI }}</div>
            <div class="col-md-3"><b>HATT:</b> {{ r.HuyetApTamThu }}</div>
            <div class="col-md-3"><b>HATTr:</b> {{ r.HuyetApTamTruong }}</div>
            <div class="col-md-3"><b>Cholesterol:</b> {{ r.Cholesterol }}</div>

            <div class="col-md-3"><b>ƒê∆∞·ªùng huy·∫øt:</b> {{ r.DuongHuyet }}</div>
            <div class="col-md-3"><b>H√∫t thu·ªëc:</b> {{ 'C√≥' if r.HutThuoc else 'Kh√¥ng' }}</div>
            <div class="col-md-3"><b>R∆∞·ª£u/Bia:</b> {{ 'C√≥' if r.UongCon else 'Kh√¥ng' }}</div>
            <div class="col-md-3"><b>T·∫≠p th·ªÉ d·ª•c:</b> {{ 'C√≥' if r.TapTheDuc else 'Kh√¥ng' }}</div>

            <div class="col-12 mt-2">
              {% if r.LoiKhuyen %}
              <div class="card border-0 shadow-sm rounded-4 p-3" style="background-color:#eaf4ff;">
                <div class="d-flex align-items-center mb-2">
                  <div class="rounded-circle bg-primary text-white d-flex align-items-center justify-content-center me-2"
                    style="width:30px;height:30px;font-size:16px;">üí°</div>
                  <h6 class="fw-bold text-primary mb-0">L·ªùi khuy√™n</h6>
                </div>
                <div class="ps-2 text-dark" style="font-size:15px; line-height:1.7; white-space:pre-line;">
                  {{ r.LoiKhuyen | safe }}
                  {% if session['role'] == 'doctor' %}
                  <button class="btn btn-link p-0 ms-2 text-warning small" data-bs-toggle="modal"
                    data-bs-target="#editAdviceModal{{ r.ChanDoanID }}">
                    ‚úèÔ∏è S·ª≠a
                  </button>
                  {% endif %}
                </div>
              </div>
              {% else %}
              {% if session['role'] == 'doctor' %}
              <button class="btn btn-sm btn-outline-success rounded-pill" data-bs-toggle="modal"
                data-bs-target="#editAdviceModal{{ r.ChanDoanID }}">
                ‚ûï Th√™m l·ªùi khuy√™n
              </button>
              {% else %}
              <span class="text-muted">‚Äî</span>
              {% endif %}
              {% endif %}
            </div>

            {% if session['role'] == 'doctor','admin','patient' %}
            <div class="col-12 text-end">
              <form method="post" action="{{ url_for('delete_history', id=r.ChanDoanID) }}"
                onsubmit="return confirm('B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a ch·∫©n ƒëo√°n n√†y kh√¥ng?');">
                <button type="submit" class="btn btn-sm btn-outline-danger rounded-pill px-4 mt-2">
                  üóë X√≥a b·∫£n ghi n√†y
                </button>
              </form>
            </div>
            {% endif %}
          </div>
        </td>
      </tr>

      <!-- Modal ch·ªânh s·ª≠a l·ªùi khuy√™n -->
      {% if session['role'] == 'doctor' %}
      <div class="modal fade" id="editAdviceModal{{ r.ChanDoanID }}" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered modal-lg">
          <div class="modal-content rounded-3 shadow">
            <form method="post" action="{{ url_for('edit_advice', id=r.ChanDoanID) }}">
              <div class="modal-header bg-warning text-dark">
                <h5 class="modal-title">‚úèÔ∏è Ch·ªânh s·ª≠a l·ªùi khuy√™n</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
              </div>
              <div class="modal-body">
                <textarea name="loi_khuyen" class="form-control" rows="6">{{ r.LoiKhuyen | striptags | safe }}</textarea>
              </div>
              <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">H·ªßy</button>
                <button type="submit" class="btn btn-success">L∆∞u</button>
              </div>
            </form>
          </div>
        </div>
      </div>
      {% endif %}
      {% endfor %}
    </tbody>
  </table>
</div>

  {% else %}
  <div class="alert alert-info mt-4 text-center rounded-4 shadow-sm">
    Ch∆∞a c√≥ d·ªØ li·ªáu ch·∫©n ƒëo√°n ph√π h·ª£p v·ªõi b·ªô l·ªçc.
  </div>
  {% endif %}
</div>

<!-- JS toggle h√†ng chi ti·∫øt (accordion ·ªïn ƒë·ªãnh) -->
<script>
  document.addEventListener("DOMContentLoaded", () => {
    // ·∫®n t·∫•t c·∫£ h√†ng chi ti·∫øt ngay khi load
    document.querySelectorAll(".detail-row").forEach(r => (r.style.display = "none"));

    const buttons = document.querySelectorAll(".toggle-detail");
    let openRow = null;
    let openBtn = null;

    buttons.forEach(btn => {
      btn.addEventListener("click", () => {
        const target = document.querySelector(btn.dataset.target);

        // N·∫øu c√≥ d√≤ng ƒëang m·ªü v√† kh√¥ng ph·∫£i d√≤ng hi·ªán t·∫°i ‚Üí ƒë√≥ng d√≤ng c≈©
        if (openRow && openRow !== target) {
          openRow.style.display = "none";
          if (openBtn) openBtn.textContent = "üîç Xem chi ti·∫øt";
          openRow = null;
          openBtn = null;
        }

        // Toggle d√≤ng hi·ªán t·∫°i
        const isOpen = target.style.display === "table-row";
        if (isOpen) {
          target.style.display = "none";
          btn.textContent = "üîç Xem chi ti·∫øt";
          openRow = null;
          openBtn = null;
        } else {
          target.style.display = "table-row";
          btn.textContent = "‚¨ÜÔ∏è Thu g·ªçn";
          openRow = target;
          openBtn = btn;
        }
      });
    });
  });
</script>

{% endblock %}
