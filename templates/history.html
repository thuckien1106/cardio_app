{% extends 'base.html' %}
{% block content %}
<div class="container mt-5 pt-4">

  <!-- Ti√™u ƒë·ªÅ -->
  <h2 class="fw-bold text-gradient mb-4">üìú L·ªãch s·ª≠ ch·∫©n ƒëo√°n</h2>
  <p class="text-muted">
    {% if session['role'] == 'doctor' %}
      Danh s√°ch k·∫øt qu·∫£ ch·∫©n ƒëo√°n c·ªßa t·∫•t c·∫£ b·ªánh nh√¢n.
    {% else %}
      L·ªãch s·ª≠ ch·∫©n ƒëo√°n c·ªßa b·∫°n.
    {% endif %}
  </p>

  {% if records and records|length > 0 %}
  <div class="table-responsive shadow-sm rounded-3 mt-4">
    <table class="table table-hover table-bordered align-middle mb-0">
      <thead class="table-light text-center">
        <tr>
          {% if session['role'] == 'doctor' %}
            <th>B·ªánh nh√¢n</th>
          {% endif %}
          <th>Tu·ªïi</th>
          <th>Gi·ªõi t√≠nh</th>
          <th>BMI</th>
          <th>HATT</th>
          <th>HATTr</th>
          <th>Cholesterol</th>
          <th>ƒê∆∞·ªùng huy·∫øt</th>
          <th>H√∫t thu·ªëc</th>
          <th>U·ªëng c·ªìn</th>
          <th>T·∫≠p th·ªÉ d·ª•c</th>
          <th>Nguy c∆°</th>
          <th>L·ªùi khuy√™n</th>
          <th>Ng√†y ch·∫©n ƒëo√°n</th>
          <th class="text-center">X√≥a</th>
        </tr>
      </thead>

      <tbody>
        {% for r in records %}
        <tr>
          {% if session['role'] == 'doctor' %}
            <td class="fw-semibold">{{ r.TenBenhNhan }}</td>
          {% endif %}

          <td class="text-center">{{ r.Tuoi if r.Tuoi is not none else '-' }}</td>
          <td class="text-center">{{ r.GioiTinh if r.GioiTinh else '-' }}</td>
          <td class="text-center">{{ r.BMI }}</td>
          <td class="text-center">{{ r.HuyetApTamThu }}</td>
          <td class="text-center">{{ r.HuyetApTamTruong }}</td>
          <td class="text-center">{{ r.Cholesterol }}</td>
          <td class="text-center">{{ r.DuongHuyet }}</td>
          <td class="text-center">{{ 'C√≥' if r.HutThuoc else 'Kh√¥ng' }}</td>
          <td class="text-center">{{ 'C√≥' if r.UongCon else 'Kh√¥ng' }}</td>
          <td class="text-center">{{ 'C√≥' if r.TapTheDuc else 'Kh√¥ng' }}</td>

          <!-- C·ªôt Nguy c∆° -->
          <td class="text-center">
            {% if 'cao' in r.NguyCo|lower %}
              <span class="badge bg-danger">{{ r.NguyCo }}</span>
            {% else %}
              <span class="badge bg-success">{{ r.NguyCo }}</span>
            {% endif %}
          </td>

          <!-- C·ªôt L·ªùi khuy√™n -->
          <td class="text-center">
            {% if r.LoiKhuyen %}
              <span class="text-truncate d-inline-block" style="max-width: 120px;">
                {{ r.LoiKhuyen[:30] }}{% if r.LoiKhuyen|length > 30 %}...{% endif %}
              </span>
              <button class="btn btn-link p-0 ms-1 text-primary small"
                      data-bs-toggle="modal"
                      data-bs-target="#adviceModal{{ r.ChanDoanID }}">
                Xem
              </button>

              {% if session['role'] == 'doctor' %}
              <button class="btn btn-link p-0 ms-1 text-warning small"
                      data-bs-toggle="modal"
                      data-bs-target="#editAdviceModal{{ r.ChanDoanID }}">
                ‚úèÔ∏è S·ª≠a
              </button>
              {% endif %}

              <!-- Modal xem l·ªùi khuy√™n -->
              <div class="modal fade" id="adviceModal{{ r.ChanDoanID }}" tabindex="-1" aria-hidden="true">
                <div class="modal-dialog modal-dialog-centered modal-lg">
                  <div class="modal-content rounded-3 shadow">
                    <div class="modal-header bg-primary text-white">
                      <h5 class="modal-title">ü©∫ L·ªùi khuy√™n t·ª´ AI</h5>
                      <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body" style="white-space: pre-wrap;">
                      {{ r.LoiKhuyen }}
                    </div>
                    <div class="modal-footer">
                      <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ƒê√≥ng</button>
                    </div>
                  </div>
                </div>
              </div>

              {% if session['role'] == 'doctor' %}
              <!-- Modal ch·ªânh s·ª≠a l·ªùi khuy√™n -->
              <div class="modal fade" id="editAdviceModal{{ r.ChanDoanID }}" tabindex="-1" aria-hidden="true">
                <div class="modal-dialog modal-dialog-centered modal-lg">
                  <div class="modal-content rounded-3 shadow">
                    <form method="post" action="{{ url_for('edit_advice', id=r.ChanDoanID) }}">
                      <div class="modal-header bg-warning text-dark">
                        <h5 class="modal-title">‚úèÔ∏è Ch·ªânh s·ª≠a l·ªùi khuy√™n</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                      </div>
                      <div class="modal-body">
                        <textarea name="loi_khuyen" class="form-control" rows="6">{{ r.LoiKhuyen }}</textarea>
                      </div>
                      <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">H·ªßy</button>
                        <button type="submit" class="btn btn-success">L∆∞u</button>
                      </div>
                    </form>
                  </div>
                </div>
              </div>
              {% endif %}

            {% else %}
              {% if session['role'] == 'doctor' %}
                <button class="btn btn-link p-0 text-success small"
                        data-bs-toggle="modal"
                        data-bs-target="#editAdviceModal{{ r.ChanDoanID }}">
                  ‚ûï Th√™m
                </button>

                <!-- Modal th√™m l·ªùi khuy√™n -->
                <div class="modal fade" id="editAdviceModal{{ r.ChanDoanID }}" tabindex="-1" aria-hidden="true">
                  <div class="modal-dialog modal-dialog-centered modal-lg">
                    <div class="modal-content rounded-3 shadow">
                      <form method="post" action="{{ url_for('edit_advice', id=r.ChanDoanID) }}">
                        <div class="modal-header bg-success text-white">
                          <h5 class="modal-title">‚ûï Th√™m l·ªùi khuy√™n</h5>
                          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body">
                          <textarea name="loi_khuyen" class="form-control" rows="6"></textarea>
                        </div>
                        <div class="modal-footer">
                          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">H·ªßy</button>
                          <button type="submit" class="btn btn-success">L∆∞u</button>
                        </div>
                      </form>
                    </div>
                  </div>
                </div>
              {% else %}
                <span class="text-muted">‚Äî</span>
              {% endif %}
            {% endif %}
          </td>

          <!-- Ng√†y ch·∫©n ƒëo√°n -->
          <td class="text-center">{{ r.NgayChanDoan.strftime('%d/%m/%Y') }}</td>

          <!-- N√∫t X√≥a -->
          <td class="text-center">
            <form method="post" action="{{ url_for('delete_history', id=r.ChanDoanID) }}"
                  onsubmit="return confirm('B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a ch·∫©n ƒëo√°n n√†y kh√¥ng?');">
              <button type="submit" class="btn btn-sm btn-outline-danger rounded-pill px-3">
                üóë X√≥a
              </button>
            </form>
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>

  {% else %}
    <div class="alert alert-info mt-4 text-center rounded-3 shadow-sm">
      Ch∆∞a c√≥ d·ªØ li·ªáu ch·∫©n ƒëo√°n.
    </div>
  {% endif %}
</div>
{% endblock %}
