{% extends 'base.html' %}
{% block content %}
<div class="container mt-4 pt-3">

    <!-- Ti√™u ƒë·ªÅ -->
    <div class="text-center mb-4">
        <h2 class="fw-bold text-gradient">ü©∫ Ch·∫©n ƒëo√°n b·ªánh tim m·∫°ch</h2>
        <p class="text-muted small">
            {% if session['role'] == 'doctor' %}
            Ch·ªçn b·ªánh nh√¢n c·∫ßn ch·∫©n ƒëo√°n, sau ƒë√≥ nh·∫≠p d·ªØ li·ªáu ho·∫∑c t·∫£i file CSV/Excel ƒë·ªÉ d·ª± ƒëo√°n nguy c∆° b·ªánh tim m·∫°ch.
            {% else %}
            Nh·∫≠p d·ªØ li·ªáu ƒë·ªÉ h·ªá th·ªëng d·ª± ƒëo√°n nguy c∆° m·∫Øc b·ªánh tim m·∫°ch.
            {% endif %}
        </p>
    </div>

    <div class="row g-3 align-items-start">
        <!-- ======== Form nh·∫≠p li·ªáu + k·∫øt qu·∫£ ======== -->
        <div class="col-lg-6">
            <div class="card shadow-sm p-4 border-0 rounded-4">
                <h4 class="text-primary mb-3">üìã Nh·∫≠p d·ªØ li·ªáu th·ªß c√¥ng</h4>

                <form method="post" id="predictForm">
                    <input type="hidden" name="predict_form" value="1">

                    {% if session['role'] == 'doctor' %}
                    <div class="mb-3">
                        <label class="form-label fw-semibold">Ch·ªçn b·ªánh nh√¢n</label>
                        <select name="benhnhan_id" class="form-select shadow-sm" required>
                            <option value="">-- Ch·ªçn b·ªánh nh√¢n --</option>
                            {% for bn in benhnhans %}
                            <option value="{{ bn.ID }}" {% if request.form.get('benhnhan_id')==bn.ID|string %}selected{%
                                endif %}>
                                {{ bn.MaBN }} - {{ bn.HoTen }}
                            </option>
                            {% endfor %}
                        </select>

                    </div>
                    {% endif %}

                    <!-- Ng∆∞·ª°ng ch·∫©n ƒëo√°n -->
                    <div class="mb-3">
                        <label class="form-label fw-semibold">Ng∆∞·ª°ng ch·∫©n ƒëo√°n</label>
                        <select name="threshold" id="threshold" class="form-select">
                            <option value="0.25" {% if request.form.get('threshold','0.5')=='0.25' %}selected{% endif
                                %}>0.25 - Nh·∫°y cao</option>
                            <option value="0.5" {% if request.form.get('threshold','0.5')=='0.5' %}selected{% endif %}>
                                0.5 - ‚≠ê C√¢n b·∫±ng</option>
                            <option value="0.75" {% if request.form.get('threshold','0.5')=='0.75' %}selected{% endif
                                %}>0.75 - ƒê·∫∑c hi·ªáu cao</option>
                        </select>
                    </div>

                    <!-- C√°c tr∆∞·ªùng nh·∫≠p -->
                    <div class="row g-2">
                        <div class="col-md-4">
                            <label class="form-label fw-semibold">Tu·ªïi</label>
                            <input type="number" name="age" id="age" class="form-control" required placeholder="VD: 45"
                                value="{{ request.form.get('age','') }}">
                        </div>
                        <div class="col-md-4">
                            <label class="form-label fw-semibold">Gi·ªõi t√≠nh</label>
                            <select name="gender" id="gender" class="form-select" required>
                                <option value="Nam" {% if request.form.get('gender')=='Nam' %}selected{% endif %}>Nam
                                </option>
                                <option value="N·ªØ" {% if request.form.get('gender')=='N·ªØ' %}selected{% endif %}>N·ªØ
                                </option>
                            </select>
                        </div>
                        <div class="col-md-4">
                            <label class="form-label fw-semibold">T·∫≠p th·ªÉ d·ª•c</label>
                            <select name="exercise" id="exercise" class="form-select">
                                <option value="yes" {% if request.form.get('exercise')=='yes' %}selected{% endif %}>C√≥
                                </option>
                                <option value="no" {% if request.form.get('exercise')=='no' %}selected{% endif %}>Kh√¥ng
                                </option>
                            </select>
                        </div>
                    </div>

                    <div class="row g-2 mt-2">
                        <div class="col-md-4">
                            <label class="form-label fw-semibold">C√¢n n·∫∑ng (kg)</label>
                            <input type="number" step="0.1" name="weight" id="weight" class="form-control" required
                               placeholder="VD: 50" value="{{ request.form.get('weight','') }}">
                        </div>
                        <div class="col-md-4">
                            <label class="form-label fw-semibold">Chi·ªÅu cao (cm)</label>
                            <input type="number" step="0.1" name="height" id="height" class="form-control" required
                               placeholder="VD: 165" value="{{ request.form.get('height','') }}">
                        </div>
                        <div class="col-md-4">
                            <label class="form-label fw-semibold">BMI</label>
                            <input type="text" id="bmi" class="form-control" readonly placeholder="T·ª± ƒë·ªông t√≠nh">
                        </div>
                    </div>

                    <div class="row g-2 mt-2">
                        <div class="col-md-6">
                            <label class="form-label fw-semibold">HATT (Huy·∫øt √°p t√¢m thu)</label>
                            <input type="number" name="systolic" id="systolic" class="form-control" required
                                placeholder="VD: 130" value="{{ request.form.get('systolic','') }}" />
                            <small class="text-muted fst-italic">
                                B√¨nh th∆∞·ªùng: <span class="text-success fw-semibold">90 ‚Äì 139 mmHg</span>
                            </small>
                        </div>

                        <div class="col-md-6">
                            <label class="form-label fw-semibold">HATTr (Huy·∫øt √°p t√¢m tr∆∞∆°ng)</label>
                            <input type="number" name="diastolic" id="diastolic" class="form-control" required
                                placeholder="VD: 85" value="{{ request.form.get('diastolic','') }}" />
                            <small class="text-muted fst-italic">
                                B√¨nh th∆∞·ªùng: <span class="text-success fw-semibold">60 ‚Äì 89 mmHg</span>
                            </small>
                        </div>
                    </div>


                    <div class="row g-2 mt-2">
                        <div class="col-md-6">
                            <label class="form-label fw-semibold">Cholesterol</label>
                            <select name="cholesterol" id="cholesterol" class="form-select">
                                <option value="normal" {% if request.form.get('cholesterol')=='normal' %}selected{%
                                    endif %}>B√¨nh th∆∞·ªùng</option>
                                <option value="above_normal" {% if request.form.get('cholesterol')=='above_normal'
                                    %}selected{% endif %}>Cao h∆°n b√¨nh th∆∞·ªùng</option>
                                <option value="high" {% if request.form.get('cholesterol')=='high' %}selected{% endif
                                    %}>Cao</option>
                            </select>
                        </div>

                        <div class="col-md-6">
                            <label class="form-label fw-semibold">ƒê∆∞·ªùng huy·∫øt</label>
                            <select name="glucose" id="glucose" class="form-select">
                                <option value="normal" {% if request.form.get('glucose')=='normal' %}selected{% endif
                                    %}>B√¨nh th∆∞·ªùng</option>
                                <option value="above_normal" {% if request.form.get('glucose')=='above_normal'
                                    %}selected{% endif %}>Cao h∆°n b√¨nh th∆∞·ªùng</option>
                                <option value="high" {% if request.form.get('glucose')=='high' %}selected{% endif %}>Cao
                                </option>
                            </select>
                        </div>

                    </div>

                    <div class="row g-2 mt-2">
                        <div class="col-md-6">
                            <label class="form-label fw-semibold">H√∫t thu·ªëc</label>
                            <select name="smoking" id="smoking" class="form-select">
                                <option value="no" {% if request.form.get('smoking')=='no' %}selected{% endif %}>Kh√¥ng
                                </option>
                                <option value="yes" {% if request.form.get('smoking')=='yes' %}selected{% endif %}>C√≥
                                </option>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label fw-semibold">U·ªëng r∆∞·ª£u/bia</label>
                            <select name="alcohol" id="alcohol" class="form-select">
                                <option value="no" {% if request.form.get('alcohol')=='no' %}selected{% endif %}>Kh√¥ng
                                </option>
                                <option value="yes" {% if request.form.get('alcohol')=='yes' %}selected{% endif %}>C√≥
                                </option>
                            </select>
                        </div>
                    </div>

                    <button type="submit" class="btn btn-success w-100 rounded-pill mt-3">
                        üîç D·ª± ƒëo√°n & Nh·∫≠n l·ªùi khuy√™n AI
                    </button>
                </form>

                {% if result %}
                <div class="mt-4 text-center">
                    <div class="small text-secondary mb-2">
                        <i class="bi bi-arrow-down-circle text-primary"></i> <b>K·∫øt qu·∫£ b·∫°n v·ª´a d·ª± ƒëo√°n</b>
                    </div>
                    <div
                        class="alert {% if risk_level == 'high' %}alert-danger{% else %}alert-success{% endif %} rounded-3 shadow-sm">
                        <strong>K·∫øt qu·∫£:</strong>
                        {% if risk_level == 'high' %} Nguy c∆° cao - {{ risk_percent }}%
                        {% else %} Nguy c∆° th·∫•p - {{ risk_percent }}%
                        {% endif %}
                        <br><small class="text-muted">Ng∆∞·ª°ng: {{ threshold }}</small>
                    </div>
                    <!-- üîµ Bi·ªÉu ƒë·ªì tr√≤n ph·∫ßn trƒÉm nguy c∆° -->
                    <div class="mt-3 text-center">
                        <h6 class="fw-semibold text-secondary mb-2">üìä Bi·ªÉu ƒë·ªì nguy c∆°</h6>
                        <canvas id="riskPieChart" width="230" height="230"
                            style="max-width:260px;margin:auto;"></canvas>
                    </div>

                    <!-- ‚úÖ N√∫t xu·∫•t file Excel -->
                    <form method="post" action="{{ url_for('export_diagnosis') }}">
                        <input type="hidden" name="benhnhan_id" value="{{ request.form.get('benhnhan_id', '') }}">
                        <input type="hidden" name="age" value="{{ request.form.get('age') }}">
                        <input type="hidden" name="gender" value="{{ request.form.get('gender') }}">
                        <input type="hidden" name="bmi"
                            value="{{ (request.form.get('weight')|float / ((request.form.get('height')|float / 100)**2))|round(2) if request.form.get('weight') and request.form.get('height') }}">
                        <input type="hidden" name="systolic" value="{{ request.form.get('systolic') }}">
                        <input type="hidden" name="diastolic" value="{{ request.form.get('diastolic') }}">
                        <input type="hidden" name="cholesterol" value="{{ request.form.get('cholesterol') }}">
                        <input type="hidden" name="glucose" value="{{ request.form.get('glucose') }}">
                        <input type="hidden" name="smoking" value="{{ request.form.get('smoking') }}">
                        <input type="hidden" name="alcohol" value="{{ request.form.get('alcohol') }}">
                        <input type="hidden" name="exercise" value="{{ request.form.get('exercise') }}">
                        <input type="hidden" name="risk_percent" value="{{ risk_percent }}">
                        <input type="hidden" name="risk_level" value="{{ risk_level }}">
                        <input type="hidden" name="ai_advice" value="{{ ai_advice }}">
                        <input type="hidden" name="shap_file" value="{{ shap_file }}">
                        <button type="submit" class="btn btn-outline-primary rounded-pill mt-2">
                            ‚¨áÔ∏è Xu·∫•t file b√°o c√°o Excel
                        </button>
                    </form>

                </div>
                {% endif %}
            </div>
        </div>

        <!-- ======== Upload file + l·ªùi khuy√™n + SHAP ======== -->
        <div class="col-lg-6">
            {% if session['role'] == 'doctor' %}
            <div class="card shadow-sm p-4 border-0 rounded-4 mb-3">
                <h4 class="text-primary mb-3">üìÇ T·∫£i file CSV/Excel</h4>
                <form method="post" enctype="multipart/form-data" id="uploadForm">
                    <input type="file" name="data_file" class="form-control mb-2" accept=".csv,.xlsx" required>
                    <button type="submit" class="btn btn-primary w-100 rounded-pill">
                        ‚¨ÜÔ∏è T·∫£i l√™n & D·ª± ƒëo√°n
                    </button>
                </form>

                {% if file_result %}
                <div class="mt-3">
                    <h5 class="fw-semibold">üìä K·∫øt qu·∫£ t·ª´ file:</h5>
                    <div class="table-responsive">{{ file_result|safe }}</div>
                </div>
                {% endif %}
            </div>
            {% endif %}

            {% if ai_advice or shap_file %}
            <div class="card shadow-sm border-0 rounded-4 p-4">
                {% if ai_advice %}
                <div class="card border-0 shadow-sm rounded-4 p-4 mt-3"
                    style="background-color:#eaf4ff; border-left:5px solid #0d6efd;">
                    <div class="d-flex align-items-center mb-3">
                        <div class="rounded-circle bg-primary text-white d-flex align-items-center justify-content-center me-2"
                            style="width:38px;height:38px;font-size:18px;">
                            üí°
                        </div>
                        <h5 class="fw-bold text-primary mb-0">L·ªùi khuy√™n</h5>
                    </div>

                    <div class="ps-1 text-dark" style="white-space: pre-line; font-size:15px; line-height:1.7;">
                        {{ ai_advice | safe }}
                    </div>
                </div>
                {% endif %}
                {% if shap_file %}
                <div class="card mt-3 shadow-sm p-3">
                    <h6 class="fw-bold text-primary mb-1">üìä Gi·∫£i th√≠ch k·∫øt qu·∫£ b·∫±ng SHAP</h6>
                    <p class="text-muted small">Bi·ªÉu ƒë·ªì th·ªÉ hi·ªán m·ª©c ƒë·ªô ·∫£nh h∆∞·ªüng c·ªßa t·ª´ng y·∫øu t·ªë ƒë·∫øn nguy c∆° b·ªánh tim.
                    </p>
                    <img src="{{ url_for('static', filename='images/' + shap_file) }}" alt="SHAP Explanation"
                        class="img-fluid rounded-3 shadow-sm">
                </div>
                {% endif %}
            </div>
            {% endif %}
        </div>
    </div>
</div>

<!-- Script t√≠nh BMI & x·ª≠ l√Ω hi·ªÉn th·ªã k·∫øt qu·∫£ -->
<script>
    const weight = document.getElementById('weight');
    const height = document.getElementById('height');
    const uploadForm = document.getElementById('uploadForm');
    const inputs = document.querySelectorAll('#predictForm input, #predictForm select');
    const resultElements = document.querySelectorAll('.alert, .card.mt-3');

    function calcBMI() {
        const w = parseFloat(weight.value);
        const h = parseFloat(height.value);
        if (w > 0 && h > 0) {
            document.getElementById('bmi').value = (w / ((h / 100) ** 2)).toFixed(2);
        } else {
            document.getElementById('bmi').value = '';
        }
    }

    function hideResults() {
        resultElements.forEach(el => {
            el.style.transition = 'opacity 0.25s ease';
            el.style.opacity = 0;
            setTimeout(() => el.style.display = 'none', 250);
        });
    }

    inputs.forEach(input => {
        input.addEventListener('input', () => {
            calcBMI();
            hideResults();
        });
    });

    if (uploadForm) {
        uploadForm.addEventListener('submit', () => hideResults());
    }

    calcBMI();
</script>
<!-- Bi·ªÉu ƒë·ªì tr√≤n ph·∫ßn trƒÉm nguy c∆° -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
{% if result %}
<script>
    document.addEventListener("DOMContentLoaded", function () {
        const ctx = document.getElementById("riskPieChart");
        if (ctx) {
            const risk = Number("{{ risk_percent }}");
            const safe = 100 - risk;
            const isHigh = "{{ risk_level }}" === "high";

            new Chart(ctx, {
                type: "doughnut",
                data: {
                    labels: ["Nguy c∆°", "An to√†n"],
                    datasets: [{
                        data: [risk, safe],
                        backgroundColor: [
                            isHigh ? "#dc3545" : "#198754",
                            "#e9ecef"
                        ],
                        borderWidth: 0
                    }]
                },
                options: {
                    cutout: "70%",
                    plugins: {
                        legend: {
                            position: "bottom",
                            labels: { font: { size: 13 } }
                        },
                        title: {
                            display: true,
                            text: `${risk}% nguy c∆°`,
                            color: isHigh ? "#dc3545" : "#198754",
                            font: { size: 18, weight: "bold" }
                        }
                    },
                    animation: { animateScale: true, animateRotate: true }
                }
            });
        }
    });
</script>
{% endif %}
<!-- ================= LOADING OVERLAY ================= -->
<style>
    #loadingOverlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100vw;
        height: 100vh;
        background: rgba(255, 255, 255, 0.8);
        display: none;
        justify-content: center;
        align-items: center;
        flex-direction: column;
        z-index: 2000;
        backdrop-filter: blur(3px);
    }

    .spinner-border {
        width: 3rem;
        height: 3rem;
        color: #007bff;
    }

    .loading-text {
        margin-top: 1rem;
        font-weight: 600;
        color: #0d6efd;
        font-size: 1.1rem;
    }
</style>

<div id="loadingOverlay">
    <div class="spinner-border" role="status"></div>
    <div class="loading-text">ü©∫ ƒêang ch·∫©n ƒëo√°n... Vui l√≤ng ch·ªù</div>
</div>

<!-- Script hi·ªÉn th·ªã overlay khi g·ª≠i form -->
<script>
    document.addEventListener("DOMContentLoaded", () => {
        const predictForm = document.getElementById("predictForm");
        const uploadForm = document.getElementById("uploadForm");
        const overlay = document.getElementById("loadingOverlay");

        function showOverlay() {
            overlay.style.display = "flex";
        }

        if (predictForm) {
            predictForm.addEventListener("submit", () => showOverlay());
        }
        if (uploadForm) {
            uploadForm.addEventListener("submit", () => showOverlay());
        }
    });
    document.addEventListener("DOMContentLoaded", () => {
        const selectPatient = document.querySelector('select[name="benhnhan_id"]');
        const inputAge = document.getElementById("age");
        const selectGender = document.getElementById("gender");

        if (selectPatient) {
            selectPatient.addEventListener("change", async () => {
                const benhnhanId = selectPatient.value;
                if (!benhnhanId) return;

                try {
                    const res = await fetch(`/get_patient_info/${benhnhanId}`);
                    if (!res.ok) throw new Error(`HTTP ${res.status}`);
                    const data = await res.json();

                    if (data.tuoi) inputAge.value = data.tuoi;
                    if (data.gioitinh) selectGender.value = data.gioitinh;

                    // Hi·ªáu ·ª©ng nh·∫π khi auto-fill
                    [inputAge, selectGender].forEach(el => {
                        el.classList.add("border-success", "bg-light");
                        setTimeout(() => el.classList.remove("border-success", "bg-light"), 1200);
                    });

                } catch (err) {
                    console.error("‚ö†Ô∏è L·ªói khi l·∫•y th√¥ng tin b·ªánh nh√¢n:", err);
                }
            });
        }

    });
</script>

{% endblock %}