{% extends 'base.html' %}
{% block content %}
<div class="container mt-4 pt-3">

    <!-- Ti√™u ƒë·ªÅ -->
    <div class="text-center mb-4">
        <h2 class="fw-bold text-gradient">ü©∫ Ch·∫©n ƒëo√°n b·ªánh tim m·∫°ch</h2>
        <p class="text-muted small">
            {% if session['role'] == 'doctor' %}
            Ch·ªçn b·ªánh nh√¢n c·∫ßn ch·∫©n ƒëo√°n, sau ƒë√≥ nh·∫≠p d·ªØ li·ªáu ho·∫∑c t·∫£i file CSV/Excel ƒë·ªÉ d·ª± ƒëo√°n nguy c∆° b·ªánh tim m·∫°ch.
            {% else %}
            Nh·∫≠p d·ªØ li·ªáu ƒë·ªÉ h·ªá th·ªëng d·ª± ƒëo√°n nguy c∆° m·∫Øc b·ªánh tim m·∫°ch.
            {% endif %}
        </p>
    </div>

    <div class="row g-3 align-items-start">

        <!-- ======== Form nh·∫≠p li·ªáu + k·∫øt qu·∫£ ======== -->
        <div class="col-lg-6">
            <div class="card shadow-sm p-4 border-0 rounded-4">
                <h4 class="text-primary mb-3">üìã Nh·∫≠p d·ªØ li·ªáu th·ªß c√¥ng</h4>

                <form method="post" id="predictForm">
                    <input type="hidden" name="predict_form" value="1">

                    {% if session['role'] == 'doctor' %}
                    <div class="mb-3">
                        <label class="form-label fw-semibold">Ch·ªçn b·ªánh nh√¢n</label>
                        <select name="benhnhan_id" class="form-select">
                            <option value="">-- Ch·ªçn b·ªánh nh√¢n --</option>
                            {% for bn in benhnhans %}
                            <option value="{{ bn.ID }}" {% if request.form.get('benhnhan_id')==bn.ID|string %}selected{% endif %}>
                                {{ bn.HoTen }} | {{ bn.GioiTinh }} | {{ bn.NgaySinh }}
                            </option>
                            {% endfor %}
                        </select>
                    </div>
                    {% endif %}

                    <!-- Ng∆∞·ª°ng ch·∫©n ƒëo√°n -->
                    <div class="mb-3">
                        <label class="form-label fw-semibold">Ng∆∞·ª°ng ch·∫©n ƒëo√°n</label>
                        <select name="threshold" id="threshold" class="form-select">
                            <option value="0.25" {% if request.form.get('threshold','0.5')=='0.25' %}selected{% endif %}>0.25 - Nh·∫°y cao</option>
                            <option value="0.5" {% if request.form.get('threshold','0.5')=='0.5' %}selected{% endif %}>0.5 - ‚≠ê C√¢n b·∫±ng</option>
                            <option value="0.75" {% if request.form.get('threshold','0.5')=='0.75' %}selected{% endif %}>0.75 - ƒê·∫∑c hi·ªáu cao</option>
                        </select>
                    </div>

                    <!-- C√°c tr∆∞·ªùng nh·∫≠p -->
                    <div class="row g-2">
                        <div class="col-md-4">
                            <label class="form-label fw-semibold">Tu·ªïi</label>
                            <input type="number" name="age" id="age" class="form-control" required placeholder="VD: 45"
                                   value="{{ request.form.get('age','') }}">
                        </div>
                        <div class="col-md-4">
                            <label class="form-label fw-semibold">Gi·ªõi t√≠nh</label>
                            <select name="gender" id="gender" class="form-select" required>
                                <option value="Nam" {% if request.form.get('gender')=='Nam' %}selected{% endif %}>Nam</option>
                                <option value="N·ªØ" {% if request.form.get('gender')=='N·ªØ' %}selected{% endif %}>N·ªØ</option>
                            </select>
                        </div>
                        <div class="col-md-4">
                            <label class="form-label fw-semibold">T·∫≠p th·ªÉ d·ª•c</label>
                            <select name="exercise" id="exercise" class="form-select">
                                <option value="yes" {% if request.form.get('exercise')=='yes' %}selected{% endif %}>C√≥</option>
                                <option value="no" {% if request.form.get('exercise')=='no' %}selected{% endif %}>Kh√¥ng</option>
                            </select>
                        </div>
                    </div>

                    <div class="row g-2 mt-2">
                        <div class="col-md-4">
                            <label class="form-label fw-semibold">C√¢n n·∫∑ng (kg)</label>
                            <input type="number" step="0.1" name="weight" id="weight" class="form-control" required
                                   value="{{ request.form.get('weight','') }}">
                        </div>
                        <div class="col-md-4">
                            <label class="form-label fw-semibold">Chi·ªÅu cao (cm)</label>
                            <input type="number" step="0.1" name="height" id="height" class="form-control" required
                                   value="{{ request.form.get('height','') }}">
                        </div>
                        <div class="col-md-4">
                            <label class="form-label fw-semibold">BMI</label>
                            <input type="text" id="bmi" class="form-control" readonly placeholder="T·ª± ƒë·ªông t√≠nh">
                        </div>
                    </div>

                    <div class="row g-2 mt-2">
                        <div class="col-md-6">
                            <label class="form-label fw-semibold">HATT</label>
                            <input type="number" name="systolic" id="systolic" class="form-control" required
                                   placeholder="VD: 130" value="{{ request.form.get('systolic','') }}">
                        </div>
                        <div class="col-md-6">
                            <label class="form-label fw-semibold">HATTr</label>
                            <input type="number" name="diastolic" id="diastolic" class="form-control" required
                                   placeholder="VD: 85" value="{{ request.form.get('diastolic','') }}">
                        </div>
                    </div>

                    <div class="row g-2 mt-2">
                        <div class="col-md-6">
                            <label class="form-label fw-semibold">Cholesterol</label>
                            <select name="cholesterol" id="cholesterol" class="form-select">
                                <option value="normal">B√¨nh th∆∞·ªùng</option>
                                <option value="above_normal">Cao h∆°n b√¨nh th∆∞·ªùng</option>
                                <option value="high">Cao</option>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label fw-semibold">ƒê∆∞·ªùng huy·∫øt</label>
                            <select name="glucose" id="glucose" class="form-select">
                                <option value="normal">B√¨nh th∆∞·ªùng</option>
                                <option value="above_normal">Cao h∆°n b√¨nh th∆∞·ªùng</option>
                                <option value="high">Cao</option>
                            </select>
                        </div>
                    </div>

                    <div class="row g-2 mt-2">
                        <div class="col-md-6">
                            <label class="form-label fw-semibold">H√∫t thu·ªëc</label>
                            <select name="smoking" id="smoking" class="form-select">
                                <option value="no" {% if request.form.get('smoking')=='no' %}selected{% endif %}>Kh√¥ng</option>
                                <option value="yes" {% if request.form.get('smoking')=='yes' %}selected{% endif %}>C√≥</option>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label fw-semibold">U·ªëng r∆∞·ª£u/bia</label>
                            <select name="alcohol" id="alcohol" class="form-select">
                                <option value="no" {% if request.form.get('alcohol')=='no' %}selected{% endif %}>Kh√¥ng</option>
                                <option value="yes" {% if request.form.get('alcohol')=='yes' %}selected{% endif %}>C√≥</option>
                            </select>
                        </div>
                    </div>

                    <button type="submit" class="btn btn-success w-100 rounded-pill mt-3">
                        üîç D·ª± ƒëo√°n & Nh·∫≠n l·ªùi khuy√™n AI
                    </button>
                </form>

                {% if result %}
                <div class="mt-4 text-center">
                    <div class="small text-secondary mb-2">
                        <i class="bi bi-arrow-down-circle text-primary"></i> <b>K·∫øt qu·∫£ b·∫°n v·ª´a d·ª± ƒëo√°n</b>
                    </div>
                    <div class="alert {% if risk_level == 'high' %}alert-danger{% else %}alert-success{% endif %} rounded-3 shadow-sm">
                        <strong>K·∫øt qu·∫£:</strong>
                        {% if risk_level == 'high' %} Nguy c∆° cao - {{ risk_percent }}%
                        {% else %} Nguy c∆° th·∫•p - {{ risk_percent }}%
                        {% endif %}
                        <br><small class="text-muted">Ng∆∞·ª°ng: {{ threshold }}</small>
                    </div>
                </div>
                {% endif %}
            </div>
        </div>

        <!-- ======== Upload file + l·ªùi khuy√™n + SHAP ======== -->
        <div class="col-lg-6">
            {% if session['role'] == 'doctor' %}
            <div class="card shadow-sm p-4 border-0 rounded-4 mb-3">
                <h4 class="text-primary mb-3">üìÇ T·∫£i file CSV/Excel</h4>
                <form method="post" enctype="multipart/form-data" id="uploadForm">
                    <input type="file" name="data_file" class="form-control mb-2" accept=".csv,.xlsx" required>
                    <button type="submit" class="btn btn-primary w-100 rounded-pill">
                        ‚¨ÜÔ∏è T·∫£i l√™n & D·ª± ƒëo√°n
                    </button>
                </form>

                {% if file_result %}
                <div class="mt-3">
                    <h5 class="fw-semibold">üìä K·∫øt qu·∫£ t·ª´ file:</h5>
                    <div class="table-responsive">{{ file_result|safe }}</div>
                </div>
                {% endif %}
            </div>
            {% endif %}

            {% if ai_advice or shap_file %}
            <div class="card shadow-sm border-0 rounded-4 p-4">
                {% if ai_advice %}
                <div class="alert alert-primary rounded-3 shadow-sm">
                    <h6 class="fw-bold mb-1">ü§ñ L·ªùi khuy√™n t·ª´ AI:</h6>
                    <p style="white-space: pre-line;">{{ ai_advice }}</p>
                </div>
                {% endif %}

                {% if shap_file %}
                <div class="card mt-3 shadow-sm p-3">
                    <h6 class="fw-bold text-primary mb-1">üìä Gi·∫£i th√≠ch k·∫øt qu·∫£ b·∫±ng SHAP</h6>
                    <p class="text-muted small">Bi·ªÉu ƒë·ªì th·ªÉ hi·ªán m·ª©c ƒë·ªô ·∫£nh h∆∞·ªüng c·ªßa t·ª´ng y·∫øu t·ªë ƒë·∫øn nguy c∆° b·ªánh tim.</p>
                    <img src="{{ url_for('static', filename='images/' + shap_file) }}" alt="SHAP Explanation"
                         class="img-fluid rounded-3 shadow-sm">
                </div>
                {% endif %}
            </div>
            {% endif %}
        </div>
    </div>
</div>

<!-- Script t√≠nh BMI & x·ª≠ l√Ω hi·ªÉn th·ªã k·∫øt qu·∫£ -->
<script>
    const weight = document.getElementById('weight');
    const height = document.getElementById('height');
    const uploadForm = document.getElementById('uploadForm');
    const inputs = document.querySelectorAll('#predictForm input, #predictForm select');
    const resultElements = document.querySelectorAll('.alert, .card.mt-3');

    function calcBMI() {
        const w = parseFloat(weight.value);
        const h = parseFloat(height.value);
        if (w > 0 && h > 0) {
            document.getElementById('bmi').value = (w / ((h / 100) ** 2)).toFixed(2);
        } else {
            document.getElementById('bmi').value = '';
        }
    }

    function hideResults() {
        resultElements.forEach(el => {
            el.style.transition = 'opacity 0.25s ease';
            el.style.opacity = 0;
            setTimeout(() => el.style.display = 'none', 250);
        });
    }

    inputs.forEach(input => {
        input.addEventListener('input', () => {
            calcBMI();
            hideResults();
        });
    });

    if (uploadForm) {
        uploadForm.addEventListener('submit', () => hideResults());
    }

    calcBMI();
</script>
{% endblock %}
