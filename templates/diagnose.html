{% extends 'base.html' %}
{% block content %}
<div class="container mt-4 pt-3">

    <!-- Ti√™u ƒë·ªÅ -->
    <div class="text-center mb-4">
        <h2 class="fw-bold text-gradient">ü©∫ Ch·∫©n ƒëo√°n b·ªánh tim m·∫°ch</h2>
        <p class="text-muted small">
            {% if session['role'] == 'doctor' %}
            Ch·ªçn b·ªánh nh√¢n c·∫ßn ch·∫©n ƒëo√°n, sau ƒë√≥ nh·∫≠p d·ªØ li·ªáu c·∫ßn thi·∫øt.
            {% else %}
            Nh·∫≠p d·ªØ li·ªáu ho·∫∑c t·∫£i file CSV/Excel ƒë·ªÉ h·ªá th·ªëng d·ª± ƒëo√°n nguy c∆° m·∫Øc b·ªánh tim m·∫°ch.
            {% endif %}
        </p>
    </div>

    <div class="row g-3">

        <!-- ======== Form nh·∫≠p li·ªáu ======== -->
        <div class="col-lg-6">
            <div class="card shadow-sm p-4 border-0 rounded-4">
                <h4 class="text-primary mb-3">üìã Nh·∫≠p d·ªØ li·ªáu</h4>

                <form method="post" id="predictForm">
                    <input type="hidden" name="predict_form" value="1">

                    <!-- N·∫øu l√† b√°c sƒ© ‚Üí ch·ªçn b·ªánh nh√¢n -->
                    {% if session['role'] == 'doctor' %}
                    <div class="mb-3">
                        <label class="form-label fw-semibold">Ch·ªçn b·ªánh nh√¢n</label>
                        <select name="benhnhan_id" class="form-select">
                            <option value="">-- Ch·ªçn b·ªánh nh√¢n --</option>
                            {% for bn in benhnhans %}
                            <option value="{{ bn.ID }}" {% if request.form.get('benhnhan_id')==bn.ID|string %}selected{%
                                endif %}>
                                {{ bn.HoTen }} | {{ bn.GioiTinh }} | {{ bn.NgaySinh }}
                            </option>
                            {% endfor %}
                        </select>
                    </div>
                    {% endif %}

                    <!-- Tu·ªïi / Gi·ªõi t√≠nh / T·∫≠p th·ªÉ d·ª•c -->
                    <div class="row g-2">
                        <div class="col-md-4">
                            <label class="form-label fw-semibold">Tu·ªïi</label>
                            <input type="number" name="age" id="age" class="form-control" required placeholder="VD: 45"
                                value="{{ request.form.get('age','') }}">
                        </div>
                        <div class="col-md-4">
                            <label class="form-label fw-semibold">Gi·ªõi t√≠nh</label>
                            <select name="gender" id="gender" class="form-select" required>
                                <option value="Nam" {% if request.form.get('gender')=='Nam' %}selected{% endif %}>Nam
                                </option>
                                <option value="N·ªØ" {% if request.form.get('gender')=='N·ªØ' %}selected{% endif %}>N·ªØ
                                </option>
                            </select>
                        </div>
                        <div class="col-md-4">
                            <label class="form-label fw-semibold">T·∫≠p th·ªÉ d·ª•c</label>
                            <select name="exercise" id="exercise" class="form-select">
                                <option value="yes" {% if request.form.get('exercise')=='yes' %}selected{% endif %}>C√≥
                                </option>
                                <option value="no" {% if request.form.get('exercise')=='no' %}selected{% endif %}>Kh√¥ng
                                </option>
                            </select>
                        </div>
                    </div>

                    <!-- C√¢n n·∫∑ng / Chi·ªÅu cao / BMI -->
                    <div class="row g-2 mt-2">
                        <div class="col-md-4">
                            <label class="form-label fw-semibold">C√¢n n·∫∑ng (kg)</label>
                            <input type="number" step="0.1" name="weight" id="weight" class="form-control" required
                                value="{{ request.form.get('weight','') }}">
                        </div>
                        <div class="col-md-4">
                            <label class="form-label fw-semibold">Chi·ªÅu cao (cm)</label>
                            <input type="number" step="0.1" name="height" id="height" class="form-control" required
                                value="{{ request.form.get('height','') }}">
                        </div>
                        <div class="col-md-4">
                            <label class="form-label fw-semibold">BMI</label>
                            <input type="text" id="bmi" class="form-control" readonly placeholder="T·ª± ƒë·ªông t√≠nh">
                        </div>
                    </div>

                    <!-- Huy·∫øt √°p -->
                    <div class="row g-2 mt-2">
                        <div class="col-md-6">
                            <label class="form-label fw-semibold">Huy·∫øt √°p t√¢m thu (HATT)</label>
                            <input type="number" name="systolic" id="systolic" class="form-control" required
                                placeholder="VD: 130" value="{{ request.form.get('systolic','') }}">
                        </div>
                        <div class="col-md-6">
                            <label class="form-label fw-semibold">Huy·∫øt √°p t√¢m tr∆∞∆°ng (HATTr)</label>
                            <input type="number" name="diastolic" id="diastolic" class="form-control" required
                                placeholder="VD: 85" value="{{ request.form.get('diastolic','') }}">
                        </div>
                    </div>

                    <!-- Cholesterol / ƒê∆∞·ªùng huy·∫øt -->
                    <div class="row g-2 mt-2">
                        <div class="col-md-6">
                            <label class="form-label fw-semibold">Cholesterol</label>
                            <select name="cholesterol" id="cholesterol" class="form-select">
                                <option value="normal" {% if request.form.get('cholesterol')=='normal' %}selected{%
                                    endif %}>B√¨nh th∆∞·ªùng</option>
                                <option value="above_normal" {% if request.form.get('cholesterol')=='above_normal'
                                    %}selected{% endif %}>Cao h∆°n b√¨nh th∆∞·ªùng</option>
                                <option value="high" {% if request.form.get('cholesterol')=='high' %}selected{% endif
                                    %}>Cao</option>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label fw-semibold">ƒê∆∞·ªùng huy·∫øt</label>
                            <select name="glucose" id="glucose" class="form-select">
                                <option value="normal" {% if request.form.get('glucose')=='normal' %}selected{% endif
                                    %}>B√¨nh th∆∞·ªùng</option>
                                <option value="above_normal" {% if request.form.get('glucose')=='above_normal'
                                    %}selected{% endif %}>Cao h∆°n b√¨nh th∆∞·ªùng</option>
                                <option value="high" {% if request.form.get('glucose')=='high' %}selected{% endif %}>Cao
                                </option>
                            </select>
                        </div>
                    </div>

                    <!-- H√∫t thu·ªëc / U·ªëng c·ªìn -->
                    <div class="row g-2 mt-2">
                        <div class="col-md-6">
                            <label class="form-label fw-semibold">H√∫t thu·ªëc</label>
                            <select name="smoking" id="smoking" class="form-select">
                                <option value="no" {% if request.form.get('smoking')=='no' %}selected{% endif %}>Kh√¥ng
                                </option>
                                <option value="yes" {% if request.form.get('smoking')=='yes' %}selected{% endif %}>C√≥
                                </option>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label fw-semibold">U·ªëng r∆∞·ª£u/bia</label>
                            <select name="alcohol" id="alcohol" class="form-select">
                                <option value="no" {% if request.form.get('alcohol')=='no' %}selected{% endif %}>Kh√¥ng
                                </option>
                                <option value="yes" {% if request.form.get('alcohol')=='yes' %}selected{% endif %}>C√≥
                                </option>
                            </select>
                        </div>
                    </div>

                    <!-- N√∫t D·ª± ƒëo√°n -->
                    <button type="submit" class="btn btn-success w-100 rounded-pill mt-3">
                        üîç D·ª± ƒëo√°n & Nh·∫≠n l·ªùi khuy√™n AI
                    </button>
                </form>

                <!-- K·∫øt qu·∫£ d·ª± ƒëo√°n -->
                <div id="resultBox">
                    {% if result %}
                    <div
                        class="alert {% if risk_level == 'high' %}alert-danger{% else %}alert-success{% endif %} mt-3 rounded-3">
                        <strong>K·∫øt qu·∫£:</strong>
                        {% if risk_level == 'high' %}
                        Nguy c∆° cao - {{ risk_percent }}%
                        {% else %}
                        Nguy c∆° th·∫•p - {{ risk_percent }}%
                        {% endif %}
                    </div>

                    {% endif %}

                    {% if ai_advice %}
                    <div class="alert alert-primary mt-3 rounded-3">
                        <h6 class="fw-bold">ü§ñ L·ªùi khuy√™n t·ª´ AI:</h6>
                        <p style="white-space: pre-line;">{{ ai_advice }}</p>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- ======== Upload file ======== -->
        <div class="col-lg-6">
            <div class="card shadow-sm p-4 border-0 rounded-4">
                <h4 class="text-primary mb-3">üìÇ T·∫£i file CSV/Excel</h4>
                <form method="post" enctype="multipart/form-data">
                    <input type="file" name="data_file" class="form-control mb-2" accept=".csv,.xlsx">
                    <button type="submit" class="btn btn-primary w-100 rounded-pill">
                        ‚¨ÜÔ∏è T·∫£i l√™n & D·ª± ƒëo√°n
                    </button>
                </form>

                {% if file_result %}
                <div class="mt-3">
                    <h5 class="fw-semibold">üìä K·∫øt qu·∫£ t·ª´ file:</h5>
                    <div class="table-responsive">{{ file_result|safe }}</div>
                </div>
                {% endif %}
            </div>
        </div>

    </div>
</div>

<!-- Script t√≠nh BMI & ·∫©n k·∫øt qu·∫£ khi thay ƒë·ªïi -->
<script>
    const weight = document.getElementById('weight');
    const height = document.getElementById('height');
    const resultBox = document.getElementById('resultBox');
    const inputs = document.querySelectorAll('#predictForm input, #predictForm select');

    function calcBMI() {
        const w = parseFloat(weight.value);
        const h = parseFloat(height.value);
        if (w > 0 && h > 0) {
            const bmi = (w / ((h / 100) ** 2)).toFixed(2);
            document.getElementById('bmi').value = bmi;
        } else {
            document.getElementById('bmi').value = '';
        }
    }

    function clearResult() {
        if (resultBox) resultBox.innerHTML = '';
    }

    inputs.forEach(input => {
        input.addEventListener('input', () => {
            calcBMI();
            clearResult();
        });
    });

    calcBMI(); // T√≠nh l·∫°i BMI khi t·∫£i trang
</script>
{% endblock %}